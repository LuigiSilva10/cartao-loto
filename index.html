
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LotoCardLDC - Local</title>
  
  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%23D81E05%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><rect x=%223%22 y=%2211%22 width=%2218%22 height=%2211%22 rx=%222%22 ry=%222%22></rect><path d=%22M7 11V7a5 5 0 0 1 10 0v4%22></path></svg>">
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Cropper.js (For image cropping) -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
  
  <!-- Tailwind CSS Configuration (from original project) -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            slate: {
              50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1',
              400: '#94a3b8', 500: '#64748b', 600: '#475569', 800: '#1e293b', 900: '#0f172a',
            },
            loto: {
              red: '#D81E05', 
              darkRed: '#b01804',
              black: '#111111',
              gray: '#2A2A2A',
              lightRed: '#FEF2F2',
              redBorder: '#FECACA',
              ldcBlue: '#0f172a'
            }
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
            mono: ['Fira Code', 'monospace'],
            serif: ['Times New Roman', 'Times', 'serif'],
          },
          boxShadow: {
            'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
            'glow': '0 0 15px rgba(216, 30, 5, 0.15)',
            'input': '0 1px 2px 0 rgba(0, 0, 0, 0.05)',
            'neon': '0 0 10px rgba(216, 30, 5, 0.4), 0 0 20px rgba(216, 30, 5, 0.2)',
            'card-hover': '0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.01)',
          },
          animation: {
            'fade-in': 'fadeIn 0.2s ease-out forwards',
            'scale-in': 'scaleIn 0.2s ease-out forwards',
            'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
          },
          keyframes: {
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
            scaleIn: { '0%': { transform: 'scale(0.95)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } },
            slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
            // slideDown defined in style tag below for specific usage
          }
        }
      }
    }
  </script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    body { font-family: 'Inter', sans-serif; }

    /* Background Pattern */
    .bg-dot-pattern {
      background-image: radial-gradient(#cbd5e1 1.5px, transparent 1.5px);
      background-size: 24px 24px;
    }

    /* ESTILO DO CARTÃO LOTO (Converted to Tailwind where possible, keeping fixed dimensions) */
    .loto-card {
      width: 76mm; height: 146mm; 
      border-radius: 6mm;
      background-color: #D81E05; /* loto-red */
      overflow: hidden;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      position: relative;
    }
    
    .loto-header-border { position: relative; }
    .loto-header-border::before {
      content: ''; position: absolute; inset: 0;
      border: 2px solid #D81E05; border-radius: 9999px;
    }

    /* Shelf Card */
    .shelf-card {
      background: white;
      border: 1px solid transparent;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.02);
    }
    .shelf-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 30px -5px rgba(0,0,0,0.08);
      border-color: transparent;
    }
    .shelf-card.selected {
      border: 1px solid #D81E05; /* loto-red */
      background-color: #FEF2F2; /* loto-lightRed */
      box-shadow: 0 0 0 2px #D81E05;
    }
    .shelf-card.selected .check-icon { opacity: 1; transform: scale(1); }

    /* Gallery Grid */
    .gallery-card {
      aspect-ratio: 1 / 1;
      transition: all 0.2s ease-out;
    }
    .gallery-card:not(.bulk-mode):hover {
      transform: scale(1.02);
      z-index: 5;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    .gallery-card.selected {
      border: 4px solid #D81E05; /* loto-red */
      transform: scale(0.98);
    }

    /* SHINE EFFECT (from original project) */
    .shine-effect {
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(to right, transparent 0%, rgba(255,255,255,0.4) 50%, transparent 100%);
        transform: skewX(-25deg);
        z-index: 20;
        pointer-events: none;
    }
    .group:hover .shine-effect {
        animation: shine 0.75s ease-in-out;
    }
    @keyframes shine {
        100% { left: 200%; }
    }

    /* Custom Styles for Cropper (from original project) */
    .cropper-view-box,
    .cropper-face {
      border-radius: 50%;
    }
    .cropper-container {
        width: 100% !important;
    }

    /* Checkbox (from original project) */
    .custom-checkbox {
      appearance: none; background-color: #fff; margin: 0;
      font: inherit; color: currentColor; width: 1.5em; height: 1.5em;
      border: 2px solid #cbd5e1; border-radius: 0.35em; display: grid; place-content: center;
    }
    .custom-checkbox::before {
      content: ""; width: 0.85em; height: 0.85em; transform: scale(0);
      transition: 0.2s transform ease-in-out; box-shadow: inset 1em 1em white;
      transform-origin: center; clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
    }
    .custom-checkbox:checked { background-color: #D81E05; border-color: #D81E05; } /* loto-red */
    .custom-checkbox:checked::before { transform: scale(1); }

    /* Scrollbar (from original project) */
    .custom-scroll::-webkit-scrollbar { width: 6px; }
    .custom-scroll::-webkit-scrollbar-track { background: transparent; }
    .custom-scroll::-webkit-scrollbar-thumb { 
      background: #cbd5e1; border-radius: 10px; border: 2px solid transparent; background-clip: content-box; 
    }
    .custom-scroll::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }

    /* Cursor styles */
    .cursor-grab { cursor: grab; }
    .cursor-grabbing { cursor: grabbing; }

    /* PRINT STYLES (from original project) */
    @media print {
      @page { margin: 0; size: A4 portrait; }
      body { background-color: white !important; margin: 0 !important; padding: 0 !important; overflow: visible !important; }
      nav, aside, .preview-header, #btn-add-card-manual, #interactive-preview-wrapper, #confirmation-modal, #alert-modal, #new-employee-modal, #crop-modal, #toast-container { display: none !important; }
      #app-container { display: none !important; }
      #print-batch-area { display: block !important; width: 100%; position: absolute; top: 0; left: 0; }
      .print-page {
        width: 210mm; height: 296mm; page-break-after: always; page-break-inside: avoid;
        display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 10mm; overflow: hidden;
      }
      .print-page:last-child { page-break-after: auto; }
      .print-row {
        display: flex; flex-direction: row; gap: 4mm; transform: scale(0.85); transform-origin: center; page-break-inside: avoid;
      }
      .loto-card { box-shadow: none !important; border: 1px dashed #9ca3af !important; print-color-adjust: exact !important; -webkit-print-color-adjust: exact !important; }
    }

    /* Toast Animation */
    @keyframes slideDownFade {
      0% { transform: translateY(-100%) scale(0.9); opacity: 0; }
      100% { transform: translateY(0) scale(1); opacity: 1; }
    }
    .animate-toast { animation: slideDownFade 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
  </style>
</head>
<body class="bg-slate-100 text-slate-800 antialiased h-screen flex flex-row overflow-hidden selection:bg-loto-red selection:text-white">
  <!-- Print Progress Overlay -->
  <div id="print-progress-overlay" class="fixed inset-x-0 top-0 z-[200] hidden transition-all duration-300">
    <div class="bg-slate-900 text-white py-3 px-6 shadow-2xl flex items-center justify-between border-b border-slate-700">
      <div class="flex items-center gap-3">
        <div class="animate-spin rounded-full h-4 w-4 border-2 border-loto-red border-t-transparent"></div>
        <span id="print-status-text" class="text-xs font-bold uppercase tracking-widest text-slate-300">Preparando documentos...</span>
      </div>
      <span id="print-progress-percent" class="text-xs font-mono font-bold text-loto-red">0%</span>
    </div>
    <div class="h-1.5 w-full bg-slate-800">
      <div id="print-progress-bar" class="h-full bg-gradient-to-r from-loto-red to-orange-500 transition-all duration-100 ease-out shadow-[0_0_10px_#D81E05]" style="width: 0%"></div>
    </div>
  </div>

  <div id="app-container" class="bg-slate-100 text-slate-800 antialiased h-screen flex flex-row overflow-hidden selection:bg-loto-red selection:text-white w-full">
    <nav id="navbar" class="w-[96px] bg-slate-900 flex flex-col items-center py-8 gap-6 z-30 flex-shrink-0 shadow-2xl"></nav>
    <aside id="sidebar" class="w-full md:w-[420px] flex-shrink-0 bg-white/80 backdrop-blur-xl border-r border-white/50 flex flex-col overflow-hidden z-20 h-full shadow-[4px_0_24px_rgba(0,0,0,0.02)]"></aside>
    <main id="preview-panel" class="flex-1 bg-white relative flex flex-col h-full overflow-hidden"></main>
  </div>

  <div id="toast-container" class="fixed top-6 left-1/2 -translate-x-1/2 z-[100] flex flex-col gap-2 pointer-events-none w-full max-w-sm items-center"></div>
  <div id="print-batch-area" class="hidden"></div>
  <div id="modals-container">
    <!-- New Employee Modal -->
    <div id="new-employee-modal" class="fixed inset-0 z-50 hidden animate-fade-in" role="dialog" aria-modal="true">
      <div class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" onclick="app.closeNewEmployeeModal()"></div>
      <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
          <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all w-full max-w-md animate-scale-in">
            <div class="bg-slate-900 px-4 py-4 sm:px-6 flex items-center justify-between">
              <h3 id="new-employee-modal-title" class="text-base font-semibold leading-6 text-white">Adicionar à Equipe</h3>
              <button onclick="app.closeNewEmployeeModal()" class="text-slate-400 hover:text-white">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
              </button>
            </div>
            <div class="px-6 py-6 space-y-4">
              <div class="flex justify-center mb-4">
                <div class="relative group cursor-pointer" onclick="document.getElementById('file-input-temp-photo').click()">
                  <div class="w-24 h-24 rounded-full bg-slate-100 border-2 border-dashed border-slate-300 flex items-center justify-center overflow-hidden hover:border-loto-red transition-colors relative">
                    <img id="temp-photo-preview" src="" alt="Employee" class="w-full h-full object-cover hidden" />
                    <div id="temp-photo-placeholder" class="text-slate-400 flex flex-col items-center">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 1 1 3.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                      <span class="text-[9px] font-bold mt-1 uppercase">Foto</span>
                    </div>
                  </div>
                  <button id="delete-photo-button" type="button" onclick="event.stopPropagation(); app.removeTempPhoto();" class="absolute -top-2 -right-2 bg-white text-slate-400 hover:text-red-500 p-1.5 rounded-full shadow-md hover:bg-red-50 transition-colors z-20 hidden border border-slate-100" title="Remover Foto">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                  </button>
                  <button id="crop-photo-button" type="button" onclick="event.stopPropagation(); app.startCropping(app.appState.tempPhoto);" class="absolute -bottom-2 -right-2 bg-white text-slate-700 p-1.5 rounded-full shadow-md hover:bg-loto-red hover:text-white transition-colors z-20 hidden border border-slate-100" title="Recortar Imagem">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6.13 1L6 16a2 2 0 0 0 2 2h15"></path><path d="M1 6.13L16 6a2 2 0 0 1 2 2v15"></path></svg>
                  </button>
                  <input type="file" id="file-input-temp-photo" class="hidden" accept="image/*" />
                </div>
              </div>
              <div>
                <label htmlFor="modal-input-name" class="block text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1.5">Nome Completo</label>
                <input
                  type="text"
                  id="modal-input-name"
                  class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold text-slate-800 focus:outline-none focus:border-indigo-500 focus:shadow-md"
                  placeholder="Ex: JOÃO DA SILVA"
                />
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1.5">Setor</label>
                  <input
                    type="text"
                    class="w-full px-4 py-3 bg-slate-100 border border-slate-200 rounded-xl text-sm font-bold text-slate-500 select-none"
                    value="MANUTENÇÃO"
                    readOnly
                  />
                </div>
                <div>
                  <label htmlFor="modal-input-role" class="block text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1.5">Função</label>
                  <div class="relative">
                    <select
                      id="modal-input-role"
                      class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold text-slate-800 outline-none appearance-none focus:border-loto-red focus:ring-1 focus:ring-loto-red/20 transition-all cursor-pointer"
                    ></select>
                    <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-slate-500"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg></div>
                  </div>
                </div>
              </div>
              
              <!-- Third Party Section -->
              <div class="pt-2 border-t border-slate-100">
                <div class="flex items-center justify-between bg-slate-50 p-3 rounded-xl border border-slate-200 mb-3">
                  <span class="text-xs font-bold text-slate-600 uppercase flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line></svg> Prestador de Serviço (Terceiro)</span>
                  <label id="third-party-toggle-label" class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="modal-input-is-third-party" class="sr-only peer" onchange="app.toggleThirdParty(this.checked)">
                    <div class="w-9 h-5 bg-slate-300 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-loto-red/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-loto-red"></div>
                  </label>
                </div>
                <div id="company-logo-section" class="hidden animate-fade-in pl-1">
                  <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2">Logo da Empresa Parceira</label>
                  <div class="flex items-center gap-4">
                    <div class="relative group cursor-pointer w-16 h-16 shrink-0 bg-white rounded-lg border-2 border-dashed border-slate-300 hover:border-loto-red transition-colors flex items-center justify-center overflow-hidden" onclick="document.getElementById('file-input-company-logo').click()">
                      <img id="company-logo-preview" src="" class="w-full h-full object-contain p-1 hidden">
                      <div id="company-logo-placeholder" class="text-slate-300"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line><path d="M15.01 9l-2.51 6.5L10 9"></path></svg></div>
                      <button id="delete-company-logo-button" type="button" onclick="event.stopPropagation(); app.removeCompanyLogo();" class="absolute top-0.5 right-0.5 bg-white/90 text-slate-400 hover:text-red-500 p-1 rounded-md shadow-sm hover:bg-red-50 transition-colors z-20 hidden" title="Remover Logo">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                      </button>
                    </div>
                    <div class="flex flex-col gap-2">
                      <div class="text-[10px] text-slate-400 leading-tight">Clique na caixa para adicionar o logo.<br>Ele aparecerá no rodapé do cartão.</div>
                      <button type="button" onclick="app.pasteCompanyLogo()" class="text-[10px] font-bold text-loto-red hover:text-loto-darkRed flex items-center gap-1 bg-red-50 hover:bg-red-100 px-2 py-1.5 rounded-lg w-fit transition-colors border border-red-100">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>
                        Colar Imagem
                      </button>
                    </div>
                    <input type="file" id="file-input-company-logo" class="hidden" accept="image/*" onchange="app.handleCompanyLogoUpload(this.files[0])">
                  </div>
                </div>
              </div>
            </div>
            <div class="bg-slate-50 px-6 py-4 flex flex-row-reverse gap-3">
              <button
                id="modal-save-employee-button"
                type="button"
                class="inline-flex w-full justify-center rounded-xl bg-slate-900 px-5 py-3 text-sm font-bold text-white shadow-sm hover:bg-slate-800 sm:w-auto"
              >
                Salvar
              </button>
              <button
                onclick="app.closeNewEmployeeModal()"
                type="button"
                class="inline-flex w-full justify-center rounded-xl bg-white px-5 py-3 text-sm font-bold text-slate-700 shadow-sm border border-slate-300 hover:bg-slate-50 sm:w-auto"
              >
                Cancelar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Crop Modal -->
    <div id="crop-modal" class="fixed inset-0 z-[70] hidden animate-fade-in" role="dialog" aria-modal="true">
      <div class="fixed inset-0 bg-black/80 backdrop-blur-sm transition-opacity"></div>
      <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
          <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all w-full max-w-lg flex flex-col max-h-[90vh]">
            <div class="bg-slate-900 px-4 py-3 flex items-center justify-between shrink-0">
              <h3 class="text-sm font-bold text-white uppercase tracking-wide">Ajustar Imagem</h3>
              <button onclick="app.closeCropModal()" class="text-slate-400 hover:text-white">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
              </button>
            </div>
            <div class="p-4 bg-slate-900 flex-1 overflow-hidden flex items-center justify-center relative min-h-[300px]">
              <img id="image-to-crop" src="" alt="Image to crop" class="max-w-full" style="display: block; max-height: 500px;" />
            </div>
            <div class="bg-slate-800 px-6 py-4 flex justify-end gap-3 shrink-0">
              <button onclick="app.closeCropModal()" class="px-4 py-2 text-xs font-bold text-white border border-slate-600 rounded-lg hover:bg-slate-700">Cancelar</button>
              <button onclick="app.performCrop()" class="px-6 py-2 text-xs font-bold text-white bg-loto-red rounded-lg hover:bg-red-600 shadow-glow">Confirmar Corte</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Alert Modal -->
    <div id="alert-modal" class="fixed inset-0 z-[60] hidden animate-fade-in" role="dialog" aria-modal="true">
      <div class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" onclick="app.closeAlertModal()"></div>
      <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
          <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all w-full max-w-sm animate-scale-in border border-slate-100">
            <div class="p-6">
              <div class="flex items-center gap-3 mb-4">
                <div class="bg-indigo-50 p-2 rounded-full text-indigo-600">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                </div>
                <h3 id="alert-modal-title" class="text-lg font-bold text-slate-900 tracking-tight"></h3>
              </div>
              <p id="alert-modal-message" class="text-sm text-slate-500 mb-6 font-medium leading-relaxed"></p>
              <button onclick="app.closeAlertModal()" class="w-full rounded-xl bg-slate-900 py-3 text-sm font-bold text-white shadow-md hover:bg-slate-800 transition-all hover:-translate-y-0.5">Entendi</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 z-[60] hidden animate-fade-in" role="dialog" aria-modal="true">
      <div class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" onclick="app.closeConfirmationModal()"></div>
      <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
          <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-md animate-scale-in border border-slate-100">
            <div class="p-6">
              <div class="flex items-center gap-4 mb-4">
                <div class="flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-red-100 sm:h-10 sm:w-10">
                  <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                  </svg>
                </div>
                <h3 id="confirmation-modal-title" class="text-lg font-bold leading-6 text-slate-900"></h3>
              </div>
              <div class="mt-2">
                <p id="confirmation-modal-message" class="text-sm text-slate-500 font-medium leading-relaxed"></p>
              </div>
            </div>
            <div class="bg-slate-50 px-6 py-4 flex flex-row-reverse gap-3 border-t border-slate-100">
              <button
                id="confirmation-modal-confirm-button"
                type="button"
                class="inline-flex w-full justify-center rounded-xl bg-red-600 px-5 py-2.5 text-sm font-bold text-white shadow-sm hover:bg-red-500 sm:ml-3 sm:w-auto transition-colors"
              >
                Sim, confirmar
              </button>
              <button
                onclick="app.closeConfirmationModal()"
                type="button"
                class="mt-3 inline-flex w-full justify-center rounded-xl bg-white px-5 py-2.5 text-sm font-bold text-slate-900 shadow-sm border border-slate-300 hover:bg-slate-50 sm:mt-0 sm:w-auto transition-colors"
              >
                Cancelar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <script>
    // Constants
    const LDC_LOGO_HTML = `<div style="display:flex;flex-direction:column;align-items:flex-start;transform-origin:bottom right;"><div style="display:flex;align-items:baseline;line-height:0.8;"><span style="font-family:'Times New Roman',serif;font-size:24px;color:#315575;transform:scaleY(1.1);">LDC</span><span style="width:5px;height:5px;background-color:#55a536;border-radius:50%;margin-left:2px;margin-bottom:2px;"></span></div><span style="font-family:'Inter',sans-serif;font-size:5px;color:#55a536;font-weight:600;margin-top:2px;">Louis Dreyfus Company</span></div>`;
    const ROLES = [
      'MECÂNICA', 'CALDEIREIRO', 'SOLDADOR'
    ];

    // --- SUPABASE SETUP ---
    // Substitua com suas próprias credenciais do Supabase
    const SUPABASE_URL = 'https://vissrgwlfhryubnplwdi.supabase.co'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZpc3NyZ3dsZmhyeXVibnBsd2RpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMjY4NjIsImV4cCI6MjA4NTcwMjg2Mn0.5cNDllbaxwrJtqwnLMZc4IrVbJsh12tJfoCwmfR1fbk';

    let supabaseClient; // Declarado mas não inicializado ainda

    // Global App State
    const app = {
      appState: {
        isLoading: true,
        employees: [],
        queue: [],
        recents: [],
        currentView: 'employees', // 'employees' | 'gallery' | 'card'
        isBulkMode: false,
        selectedBulkIds: new Set(),
        currentPreviewId: null,
        expandedQueue: new Set(),

        // Modal States
        isNewEmployeeModalOpen: false,
        editingEmployeeId: null,
        tempPhoto: null,
        tempCompanyLogo: null,
        isThirdParty: false,
        isCropModalOpen: false,
        imageToCropSrc: '',
        cropperInstance: null,
        isAlertModalOpen: false,
        alertModalContent: { title: '', message: '' },
        isConfirmationModalOpen: false,
        confirmationModalContent: { title: '', message: '', onConfirm: () => {} },
        activeSaveCallback: null,
      },

      // --- State Management Helpers ---
      _updateState(newState, shouldRender = true) {
        Object.assign(this.appState, newState);
        if (shouldRender) this.renderApp(); // Re-render the relevant parts of the UI
      },
      
      async _saveRecents() {
        const { error } = await supabaseClient
          .from('settings')
          .upsert({ key: 'recents', value: { recents: this.appState.recents } });

        if (error) {
          console.error('Erro ao salvar recentes:', error);
          // Falha silenciosa: Não exibir toast de erro para não interromper o fluxo do usuário
        }
      },

      async _loadInitialData() {
        // Fetch employees
        const { data: employees, error: employeesError } = await supabaseClient
          .from('employees')
          .select('*')
          .order('created_at', { ascending: false });

        if (employeesError) {
          console.error('Erro ao carregar colaboradores:', employeesError);
          this.showAlert('Erro de Conexão', 'Não foi possível carregar os dados dos colaboradores. Verifique sua conexão e as configurações do Supabase.');
          return;
        }
        this.appState.employees = employees || [];

        // Fetch recents
        const { data: recentsSetting, error: recentsError } = await supabaseClient
          .from('settings')
          .select('value')
          .eq('key', 'recents')
          .single();
        
        this.appState.recents = recentsSetting?.value?.recents || [];
      },

      // --- UI Rendering Functions ---
      renderApp() {
        this.renderNavbar();
        this.renderSidebar();
        this.renderPreviewPanel();
        this.syncNewEmployeeModal();
        this.syncCropModal();
        this.syncAlertModal();
        this.syncConfirmationModal();
      },

      renderNavbar() {
        const navbarElement = document.getElementById('navbar');
        if (!navbarElement) return;

        const getNavButtonHtml = (view, iconSvg, label) => {
          const isActive = this.appState.currentView === view;
          const textClasses = isActive ? 'text-white font-bold' : 'text-slate-400 font-medium group-hover:text-slate-200';
          const bgClasses = isActive ?
            'w-12 h-12 rounded-2xl bg-loto-red text-white shadow-[0_0_20px_rgba(216,30,5,0.4)] flex items-center justify-center transition-all duration-300 transform scale-105' :
            'w-12 h-12 rounded-2xl bg-slate-800/50 text-slate-400 group-hover:bg-slate-800 group-hover:text-white flex items-center justify-center transition-all duration-300';
          const indicatorClasses = `active-indicator absolute -right-[18px] top-1/2 -translate-y-1/2 w-1.5 h-8 bg-loto-red rounded-l-full shadow-[0_0_15px_#D81E05] ${isActive ? '' : 'hidden'}`;
          
          let queueCountBadge = '';
          if (view === 'card') {
            queueCountBadge = `<span class="absolute -top-1.5 -right-1.5 flex h-5 w-5 items-center justify-center rounded-full bg-white text-loto-red text-[10px] font-black shadow-sm transition-opacity ${this.appState.queue.length > 0 ? 'opacity-100' : 'opacity-0'} border-2 border-slate-900">${this.appState.queue.length}</span>`;
          }

          return `
            <button class="group flex flex-col items-center gap-2 p-2 w-full transition-all duration-300 relative" data-view="${view}">
              <div class="${bgClasses} relative">
                ${iconSvg}
                ${queueCountBadge}
              </div>
              <span class="${textClasses} text-[9px] tracking-widest uppercase">${label}</span>
              <div class="${indicatorClasses}"></div>
            </button>
          `;
        };

        navbarElement.innerHTML = `
          <div class="bg-gradient-to-br from-loto-red to-loto-darkRed text-white p-3.5 rounded-2xl shadow-glow mb-6 mx-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
          </div>
          <div class="flex flex-col gap-5 w-full px-2">
            ${getNavButtonHtml('employees', '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>', 'Equipe')}
            ${getNavButtonHtml('gallery', '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>', 'Galeria')}
            ${getNavButtonHtml('card', '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><path d="M6 14h12v8H6z"/></svg>', 'Fila')}
            ${getNavButtonHtml('history', '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>', 'Histórico')}
          </div>
        `;

        navbarElement.querySelectorAll('button[data-view]').forEach(button => {
          button.addEventListener('click', (e) => {
            const view = e.currentTarget.dataset.view;
            this.switchView(view);
          });
        });
      },

      renderSidebar() {
        const sidebarElement = document.getElementById('sidebar');
        if (!sidebarElement) return;

        let title = '';
        let description = '';
        let tagText = '';
        let tagClasses = '';

        if (this.appState.currentView === 'employees') {
          title = 'Colaboradores';
          description = 'Selecione para adicionar à fila de impressão.';
          tagText = 'Biblioteca';
          tagClasses = 'bg-indigo-100 text-indigo-700 border-indigo-200';
        } else if (this.appState.currentView === 'gallery') {
          title = 'Galeria';
          description = 'Gerencie fotos e cadastros.';
          tagText = 'Acervo';
          tagClasses = 'bg-emerald-100 text-emerald-700 border-emerald-200';
        } else if (this.appState.currentView === 'card') { // 'card' view (queue)
          title = 'Fila de Impressão';
          description = 'Revise antes de imprimir.';
          tagText = 'Impressão';
          tagClasses = 'bg-amber-100 text-amber-700 border-amber-200';
        } else { // 'history' view
          title = 'Histórico';
          description = 'Colaboradores acessados recentemente.';
          tagText = 'Recentes';
          tagClasses = 'bg-cyan-100 text-cyan-700 border-cyan-200';
        }

        const panelHeaderHtml = `
          <div class="px-8 py-10 flex flex-col gap-2 relative overflow-hidden shrink-0">
            <div class="flex items-center gap-2 mb-1 z-10">
              <span class="text-[10px] font-black px-2.5 py-1 rounded-md border uppercase tracking-widest ${tagClasses}">
                # ${tagText}
              </span>
            </div>
            <h1 class="text-2xl font-bold text-slate-900 tracking-tight z-10">${title}</h1>
            <p class="text-sm text-slate-500 font-medium z-10">${description}</p>
          </div>
        `;

        let panelActionsHtml = '';
        if (this.appState.currentView === 'card') {
          panelActionsHtml = ` 
            <div class="p-6 border-t border-slate-100 bg-white/50 backdrop-blur-sm z-20">
              <div class="flex flex-col gap-3">
                <button
                  id="print-queue-button"
                  type="button"
                  class="w-full bg-loto-red text-white font-bold py-4 px-4 rounded-2xl hover:bg-loto-darkRed shadow-lg shadow-loto-red/30 hover:shadow-xl hover:shadow-loto-red/40 hover:-translate-y-0.5 transition-all flex items-center justify-center gap-2.5"
                >
                  IMPRIMIR FILA (${this.appState.queue.length})
                </button>
              </div>
            </div>
          `;
        } else {
          // Removed the empty state footer for cleaner look in other views
          panelActionsHtml = '';
        }
        
        // Render main structure
        sidebarElement.innerHTML = `
          ${panelHeaderHtml}
          <div id="sidebar-content" class="flex-1 overflow-y-auto custom-scroll relative px-2"></div>
          ${panelActionsHtml}
        `;

        // Render content based on current view
        const sidebarContentElement = document.getElementById('sidebar-content');
        if (sidebarContentElement) {
          if (this.appState.isLoading) {
            sidebarContentElement.innerHTML = `
              <div class="flex items-center justify-center h-full p-10 animate-fade-in">
                <div class="flex flex-col items-center gap-4">
                  <svg class="animate-spin h-8 w-8 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  <span class="text-sm font-medium text-slate-500">Carregando colaboradores...</span>
                </div>
              </div>
            `;
          } else {
            if (this.appState.currentView === 'employees') {
              this.renderEmployeesTabContent(sidebarContentElement);
            } else if (this.appState.currentView === 'gallery') {
              this.renderGalleryTabContent(sidebarContentElement);
            } else if (this.appState.currentView === 'card') {
              this.renderGeneratorTabContent(sidebarContentElement);
            } else if (this.appState.currentView === 'history') {
              this.renderHistoryTabContent(sidebarContentElement);
            }
          }
        }

        // Add event listeners for sidebar actions
        if (this.appState.currentView === 'card') {
          document.getElementById('print-queue-button')?.addEventListener('click', () => this.printQueue());
        }
      },

      renderEmployeesTabContent(container) {
        let employeesHtml = '';
        if (this.appState.employees.length === 0) {
          employeesHtml = `<div class="col-span-full text-center text-xs text-slate-400 py-4">Vazio</div>`;
        } else {
          employeesHtml = this.appState.employees.map(e => this.getEmployeeCardHtml(e)).join('');
        }

        container.innerHTML = `
          <div class="animate-in fade-in px-6 pb-6 min-h-full">
            <div class="flex justify-between items-center mb-6 sticky top-0 bg-white/90 backdrop-blur-md py-3 z-10 -mx-2 px-2 rounded-xl">
              <div class="flex items-center gap-2">
                <div class="h-2 w-2 rounded-full bg-emerald-500 animate-pulse"></div>
                <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Disponíveis</span>
                <span class="text-[10px] bg-slate-100 text-slate-600 px-2.5 py-1 rounded-full font-bold border border-slate-200">
                  ${this.appState.employees.length}
                </span>
              </div>
              <button id="delete-all-employees-btn" class="text-[10px] font-bold text-red-400 hover:text-red-600 hover:bg-red-50 px-2 py-1 rounded-md transition-colors ${this.appState.employees.length === 0 ? 'hidden' : ''}" title="Excluir todos">
                Excluir Todos
              </button>
            </div>
            <button
              id="add-employee-button"
              class="w-full mb-6 group relative overflow-hidden rounded-2xl bg-slate-900 p-0.5 shadow-xl shadow-slate-900/20 transition-all hover:shadow-2xl hover:shadow-slate-900/30 hover:-translate-y-0.5"
            >
              <div class="relative flex items-center justify-between rounded-xl bg-slate-900 px-6 py-5">
                <div class="flex items-center gap-3">
                  <div class="flex h-10 w-10 items-center justify-center rounded-full bg-white/10 text-white group-hover:bg-loto-red group-hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>
                  </div>
                  <div class="text-left">
                    <p class="text-sm font-bold text-white">Adicionar Colaborador</p>
                    <p class="text-[10px] text-slate-400">Cadastrar novo</p>
                  </div>
                </div>
              </div>
            </button>
            <div id="employee-cards-grid" class="grid grid-cols-1 gap-3 pb-8">
              ${employeesHtml}
            </div>
          </div>
        `;

        document.getElementById('add-employee-button')?.addEventListener('click', () => this.openNewEmployeeModal());
        document.getElementById('delete-all-employees-btn')?.addEventListener('click', () => this.deleteAllEmployees());
        
        const handleCardClick = (e) => {
          const target = e.target;
          const employeeCard = target.closest('.shelf-card');
          if (employeeCard) {
            const id = parseInt(employeeCard.dataset.id);
            if (!isNaN(id)) {
              if (target.closest('.delete-button')) {
                this.deleteEmployee(id);
              } else if (target.closest('.edit-button')) {
                this.openNewEmployeeModal(id);
              } else {
                this.toggleQueue(id);
              }
            }
          }
        };

        document.getElementById('employee-cards-grid')?.addEventListener('click', handleCardClick);
      },

      renderGalleryTabContent(container) {
        let galleryCardsHtml = '';
        if (this.appState.employees.length === 0) {
          galleryCardsHtml = `<div class="col-span-full text-center text-xs text-slate-400 py-4">Sem fotos</div>`;
        } else {
          galleryCardsHtml = this.appState.employees.map(e => this.getGalleryCardHtml(e)).join('');
        }

        container.innerHTML = `
          <div class="animate-in fade-in px-6 pb-6 min-h-full">
            <div class="flex justify-between items-center mb-6 sticky top-0 bg-white/90 backdrop-blur-md z-20 py-3 -mx-2 px-2 rounded-xl">
              <h2 class="font-bold text-slate-800 text-sm tracking-wide flex items-center gap-2">
                ACERVO DE FOTOS
                <span class="bg-loto-red text-white text-[10px] px-2 py-0.5 rounded-full ${this.appState.isBulkMode && this.appState.selectedBulkIds.size > 0 ? '' : 'hidden'}">
                  ${this.appState.selectedBulkIds.size}
                </span>
              </h2>
              <div class="flex gap-2">
                <button
                  id="toggle-bulk-mode-button"
                  class="text-[10px] font-bold uppercase tracking-wider px-3 py-1.5 rounded-lg border border-slate-300 text-slate-600 hover:bg-white transition-all bg-white shadow-sm"
                >
                  ${this.appState.isBulkMode ? 'Cancelar' : 'Selecionar'}
                </button>
                <button
                  id="delete-bulk-button"
                  class="text-[10px] font-bold uppercase tracking-wider px-3 py-1.5 rounded-lg bg-red-50 text-red-600 border border-red-100 hover:bg-red-100 transition-all flex items-center gap-1 ${this.appState.isBulkMode ? '' : 'hidden'}"
                >
                  Excluir
                </button>
              </div>
            </div>
            <div id="gallery-cards-grid" class="grid grid-cols-2 md:grid-cols-3 gap-3 pb-8">
              ${galleryCardsHtml}
            </div>
            <button
              id="add-employee-gallery-button"
              class="w-full mb-6 group relative overflow-hidden rounded-2xl bg-slate-50 border-2 border-slate-200 border-dashed p-4 transition-all hover:border-loto-red hover:bg-red-50/50"
            >
              <div class="flex items-center justify-center gap-2 text-slate-500 group-hover:text-loto-red">
                <span class="text-xs font-bold uppercase tracking-wider">+ Adicionar Nova Foto</span>
              </div>
            </button>
          </div>
        `;

        document.getElementById('toggle-bulk-mode-button')?.addEventListener('click', () => this.toggleBulkMode());
        document.getElementById('delete-bulk-button')?.addEventListener('click', () => this.deleteBulk());
        document.getElementById('add-employee-gallery-button')?.addEventListener('click', () => this.openNewEmployeeModal());

        document.getElementById('gallery-cards-grid')?.addEventListener('click', (e) => {
          const target = e.target;
          const galleryCard = target.closest('.gallery-card');
          if (!galleryCard) return;

          const id = parseInt(galleryCard.dataset.id);
          if (isNaN(id)) return;

          if (this.appState.isBulkMode) {
            this.toggleBulkSelection(id);
          } else {
            if (target.closest('.delete-button')) {
              this.deleteEmployee(id);
            } else if (target.closest('.edit-button')) {
              this.openNewEmployeeModal(id);
            } else {
              this.toggleQueue(id);
            }
          }
        });
      },

      renderGeneratorTabContent(container) {
        const validQueue = this.appState.queue.filter(id => this.appState.employees.some(e => e.id === id));

        let queueItemsHtml = '';
        if (validQueue.length === 0) {
          queueItemsHtml = `
            <div class="text-center py-12 flex flex-col items-center justify-center border-2 border-dashed border-slate-200 rounded-2xl">
              <p class="text-sm text-slate-500 font-medium">Fila vazia</p>
            </div>
          `;
        } else {
          queueItemsHtml = validQueue.map((id, idx) => {
            const employee = this.appState.employees.find(e => e.id === id);
            return employee ? this.getQueueItemHtml(employee, idx + 1) : '';
          }).join('');
        }

        container.innerHTML = `
          <div class="animate-in fade-in px-6 pb-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="font-bold text-slate-800 text-sm tracking-wide">ITENS SELECIONADOS</h2>
              <button id="clear-queue-button" class="text-[10px] text-red-500 font-bold hover:underline">
                Limpar Fila
              </button>
            </div>
            <div id="queue-items-container" class="space-y-4 pb-20">
              ${queueItemsHtml}
            </div>
          </div>
        `;

        document.getElementById('clear-queue-button')?.addEventListener('click', () => this.clearQueue());
        
        document.getElementById('queue-items-container')?.addEventListener('click', (e) => {
          const target = e.target;
          const queueItem = target.closest('.queue-item-wrapper');
          if (!queueItem) return;

          const id = parseInt(queueItem.dataset.id);
          if (isNaN(id)) return;

          if (target.closest('.remove-button')) {
            this.removeFromQueue(id);
          } else if (target.closest('.expand-button')) {
            this.toggleExpand(id);
          } else {
            this.setCurrentPreviewId(id);
          }
        });
      },

      renderHistoryTabContent(container) {
        const recentEmployees = this.appState.recents
            .map(id => this.appState.employees.find(e => e.id === id))
            .filter(e => e);

        let historyHtml = '';
        if (recentEmployees.length === 0) {
            historyHtml = `
                <div class="text-center py-12 flex flex-col items-center justify-center border-2 border-dashed border-slate-200 rounded-2xl">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-slate-300 mb-3"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    <p class="text-sm text-slate-500 font-medium">Nenhum item recente</p>
                    <p class="text-xs text-slate-400 mt-1">Adicione ou edite colaboradores para vê-los aqui.</p>
                </div>
            `;
        } else {
            historyHtml = recentEmployees.map(e => this.getEmployeeCardHtml(e)).join('');
        }

        container.innerHTML = `
            <div class="animate-in fade-in px-6 pb-6 min-h-full">
                <div class="flex justify-between items-center mb-6 sticky top-0 bg-white/90 backdrop-blur-md py-3 z-10 -mx-2 px-2 rounded-xl">
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Visualizando Recentes</span>
                        <span class="text-[10px] bg-slate-100 text-slate-600 px-2.5 py-1 rounded-full font-bold border border-slate-200">
                            ${recentEmployees.length}
                        </span>
                    </div>
                    <button id="clear-recents-btn" class="text-[10px] font-bold text-red-400 hover:text-red-600 hover:bg-red-50 px-2 py-1 rounded-md transition-colors ${recentEmployees.length === 0 ? 'hidden' : ''}" title="Limpar Histórico">
                        Limpar
                    </button>
                </div>
                <div id="history-cards-grid" class="grid grid-cols-1 gap-3 pb-8">
                    ${historyHtml}
                </div>
            </div>
        `;

        document.getElementById('clear-recents-btn')?.addEventListener('click', () => this.clearRecents());

        document.getElementById('history-cards-grid')?.addEventListener('click', (e) => {
            const target = e.target;
            const employeeCard = target.closest('.shelf-card');
            if (employeeCard) {
                const id = parseInt(employeeCard.dataset.id);
                if (!isNaN(id)) {
                    if (target.closest('.delete-button')) this.deleteEmployee(id);
                    else if (target.closest('.edit-button')) this.openNewEmployeeModal(id);
                    else this.toggleQueue(id);
                }
            }
        });
      },

      renderPreviewPanel() {
        const panelElement = document.getElementById('preview-panel');
        if (!panelElement) return;

        const employee = this.appState.currentPreviewId ? this.appState.employees.find(e => e.id === this.appState.currentPreviewId) : null;
        const isThirdParty = employee?.isThirdParty && employee?.companyLogo;
        const isLocked = employee?.logoSettings?.locked || false;

        let thirdPartyControls = '';
        if (isThirdParty) {
            thirdPartyControls = `
                <div class="flex items-center gap-3 bg-white/90 backdrop-blur-md px-3 py-1.5 rounded-full shadow-md border border-slate-200 animate-fade-in">
                    <div class="flex items-center gap-1.5 text-slate-500">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path></svg>
                        <span class="text-[10px] font-bold uppercase tracking-wider">Logo</span>
                    </div>
                    <div class="w-px h-3 bg-slate-300"></div>
                    <button id="toggle-logo-lock" class="text-slate-400 hover:text-loto-red transition-colors p-1" title="${isLocked ? 'Destravar Logo' : 'Travar Logo'}">
                        ${isLocked 
                            ? `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-loto-red"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>` 
                            : `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path></svg>`
                        }
                    </button>
                </div>
            `;
        }

        panelElement.innerHTML = `
          <div class="h-24 border-b border-slate-200/60 bg-white/80 backdrop-blur-md flex items-center justify-between px-10 shrink-0 preview-header z-10 sticky top-0">
            <div class="flex items-center gap-3">
              <div class="bg-slate-50 p-2.5 rounded-xl shadow-inner text-loto-red">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12h10"/><path d="M9 4v16"/><path d="m3 9 3 3-3 3"/><path d="M14 8V7c0-1.1.9-2 2-2h6"/><path d="M14 12h8"/><path d="M14 16v1c0 1.1.9 2 2 2h6"/></svg>
              </div>
              <div>
                <span class="text-xs font-bold text-slate-400 uppercase tracking-wider block">Preview</span>
                <span class="text-lg font-bold text-slate-800 tracking-tight">Visualização em Tempo Real</span>
              </div>
            </div>
          </div>

          <div
            id="preview-viewport"
            class="flex-1 overflow-hidden relative cursor-grab bg-slate-50 bg-dot-pattern flex items-center justify-center"
          >
            <div class="absolute bottom-6 right-6 z-30 flex items-center gap-2">
              ${thirdPartyControls}
              <button
                id="reset-zoom-button"
                class="bg-white text-slate-500 border border-slate-200 shadow-md hover:text-loto-red px-4 py-2 text-xs font-bold uppercase rounded-full"
              >
                Resetar Vista
              </button>
            </div>

            <div id="interactive-preview-wrapper" class="flex flex-col xl:flex-row gap-12 xl:gap-6 items-start justify-center py-4 origin-center transition-transform duration-75">
              ${this.getLotoCardHtml(employee)}
              ${this.getLotoCardHtml(employee, true)}
            </div>
          </div>
        `;

        // Attach event listeners for zoom/pan
        const previewViewport = document.getElementById('preview-viewport');
        const interactiveWrapper = document.getElementById('interactive-preview-wrapper');
        const resetZoomButton = document.getElementById('reset-zoom-button');

        let scale = 0.65;
        let translateX = 0;
        let translateY = 0;
        let isPanning = false;
        let startX = 0;
        let startY = 0;

        const updateTransform = () => {
          if (interactiveWrapper) {
            interactiveWrapper.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
          }
        };

        const handleMouseDown = (e) => {
          if (e.target.closest('button')) return; // Ignore clicks on buttons
          isPanning = true;
          startX = e.clientX - translateX;
          startY = e.clientY - translateY;
          previewViewport?.classList.add('cursor-grabbing');
        };

        const handleMouseMove = (e) => {
          if (!isPanning) return;
          e.preventDefault();
          translateX = e.clientX - startX;
          translateY = e.clientY - startY;
          updateTransform();
        };

        const handleMouseUp = () => {
          isPanning = false;
          previewViewport?.classList.remove('cursor-grabbing');
        };

        const handleWheel = (e) => {
          e.preventDefault();
          const newScale = Math.min(Math.max(0.5, scale - Math.sign(e.deltaY) * 0.1), 3);

          // Adjust translateX and translateY to zoom around the cursor
          const rect = interactiveWrapper.getBoundingClientRect();
          const mouseX = e.clientX - rect.left;
          const mouseY = e.clientY - rect.top;

          translateX = translateX - (mouseX / scale) * (newScale - scale);
          translateY = translateY - (mouseY / scale) * (newScale - scale);

          scale = newScale;
          updateTransform();
        };

        const resetZoom = () => {
          scale = 0.65;
          translateX = 0;
          translateY = 0;
          updateTransform();
        };

        previewViewport?.addEventListener('mousedown', handleMouseDown);
        previewViewport?.addEventListener('mousemove', handleMouseMove);
        previewViewport?.addEventListener('wheel', handleWheel);
        resetZoomButton?.addEventListener('click', resetZoom);
        window.addEventListener('mouseup', handleMouseUp); // Listen globally for mouse up

        // --- LOGIC FOR LOGO DRAG & RESIZE (MODERN) ---
        const logoContainer = panelElement.querySelector('.logo-container-absolute');
        const logoWrapper = panelElement.querySelector('.logo-resizable-wrapper');
        
        if (logoContainer && logoWrapper && employee?.isThirdParty) {
          // Criar as 4 alças de redimensionamento (Handles)
          const handles = ['nw', 'ne', 'sw', 'se'];
          const handleElements = {};

          handles.forEach(dir => {
            const h = document.createElement('div');
            h.className = `resize-handle ${dir}`;
            h.style.cssText = `
                width: 10px; height: 10px;
                background-color: white;
                border: 1px solid #D81E05;
                border-radius: 50%;
                position: absolute;
                z-index: 50;
                display: none;
            `;
            
            // Posicionamento específico
            if (dir.includes('n')) h.style.top = '-5px'; else h.style.bottom = '-5px';
            if (dir.includes('w')) h.style.left = '-5px'; else h.style.right = '-5px';
            
            // Cursor
            h.style.cursor = `${dir}-resize`;
            
            logoContainer.appendChild(h);
            handleElements[dir] = h;
          });

          // Lock Button Logic
          const lockBtn = document.getElementById('toggle-logo-lock');
          if (lockBtn) {
            lockBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                // FIX: Buscar o colaborador mais recente do estado para garantir que temos as coordenadas atualizadas após o arrasto
                const latestEmployee = app.appState.employees.find(e => e.id === employee.id) || employee;
                const currentSettings = latestEmployee.logoSettings || { top: 'auto', left: 'auto', width: '85px', height: 'auto' };
                const newLockedState = !currentSettings.locked;
                
                app.saveLogoSettings(employee.id, { ...currentSettings, locked: newLockedState });
                app.renderPreviewPanel(); // Re-render to update icon and state
                
                app.showToast(newLockedState ? 'Logo travado.' : 'Logo destravado.', 'pop');
            });
          }

          // Save Button Logic
          const saveBtn = document.getElementById('save-logo-pos-btn');
          if (saveBtn) {
            saveBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                app.saveLogoSettings(employee.id, {
                  top: logoContainer.style.top,
                  left: logoContainer.style.left,
                  width: logoWrapper.style.width,
                  height: logoWrapper.style.height
                });
                
                // Visual feedback
                saveBtn.classList.add('bg-emerald-100');
                setTimeout(() => saveBtn.classList.remove('bg-emerald-100'), 200);
                app.showToast('Posição do logo salva!', 'success');
            });
          }

          // Drag Logic
          if (isLocked) {
            logoContainer.style.cursor = 'default';
            logoContainer.title = "Logo travado (Clique no cadeado para editar)";
          } else {
            logoContainer.style.cursor = 'move';
            logoContainer.title = "Arraste para mover";
          }
          
          // Visual hover effect
          logoContainer.addEventListener('mouseenter', () => {
             if (employee?.logoSettings?.locked) return; // Don't show handles if locked
             logoContainer.style.outline = '1px dashed #D81E05'; 
             Object.values(handleElements).forEach(h => h.style.display = 'block');
          });
          logoContainer.addEventListener('mouseleave', () => {
             logoContainer.style.outline = 'none';
             Object.values(handleElements).forEach(h => h.style.display = 'none');
          });

          let isDragging = false;
          let isResizing = false;
          let resizeDir = ''; // 'nw', 'ne', 'sw', 'se'
          let startX, startY, startLeft, startTop, startWidth, startHeight, aspectRatio;

          const onMouseDown = (e) => {
            e.stopPropagation(); // Prevent preview pan
            e.preventDefault();

            if (employee?.logoSettings?.locked) {
                app.showToast('Logo travado. Clique no cadeado para editar.', 'error');
                return;
            }
            
            // Verifica se clicou em uma alça
            if (e.target.classList.contains('resize-handle')) {
                isResizing = true;
                isDragging = false;
                resizeDir = e.target.classList.contains('nw') ? 'nw' : 
                            e.target.classList.contains('ne') ? 'ne' :
                            e.target.classList.contains('sw') ? 'sw' : 'se';
                
                startWidth = parseInt(logoWrapper.style.width, 10) || logoWrapper.offsetWidth;
                startHeight = logoWrapper.offsetHeight;
                aspectRatio = startWidth / startHeight;
                
                // Captura posições iniciais para cálculos de Top/Left
                startLeft = parseFloat(logoContainer.style.left) || logoContainer.offsetLeft;
                startTop = parseFloat(logoContainer.style.top) || logoContainer.offsetTop;

                document.body.style.cursor = e.target.style.cursor;
            } else {
                isDragging = true;
                isResizing = false;
                
                // Get current positions (handle auto/bottom/right)
                if (!logoContainer.style.left || logoContainer.style.left === 'auto') {
                    logoContainer.style.left = (logoContainer.offsetLeft) + 'px';
                    logoContainer.style.top = (logoContainer.offsetTop) + 'px';
                    logoContainer.style.bottom = 'auto';
                    logoContainer.style.right = 'auto';
                }

                startLeft = parseFloat(logoContainer.style.left);
                startTop = parseFloat(logoContainer.style.top);

                logoContainer.style.cursor = 'grabbing';
                document.body.style.cursor = 'grabbing';
            }

            startX = e.clientX;
            startY = e.clientY;
          };

          const onMouseMove = (e) => {
            if (!isDragging && !isResizing) return;
            e.preventDefault();
            
            // Calculate delta considering scale
            const dx = (e.clientX - startX) / scale;
            const dy = (e.clientY - startY) / scale;

            if (isDragging) {
                let newLeft = startLeft + dx;
                let newTop = startTop + dy;

                // Grade Magnética (Snap-to-grid)
                const gridSize = 10;
                newLeft = Math.round(newLeft / gridSize) * gridSize;
                newTop = Math.round(newTop / gridSize) * gridSize;

                logoContainer.style.left = `${newLeft}px`;
                logoContainer.style.top = `${newTop}px`;

                // Sync mirrors
                const sidebarMirrors = document.querySelectorAll(`.queue-item-wrapper[data-id="${employee.id}"] .logo-container-absolute`);
                sidebarMirrors.forEach(mirror => {
                  mirror.style.left = `${newLeft}px`;
                  mirror.style.top = `${newTop}px`;
                  mirror.style.bottom = 'auto';
                  mirror.style.right = 'auto';
                });
            } else if (isResizing) {
                let newWidth = startWidth;
                let newLeft = startLeft;
                let newTop = startTop;

                // Lógica para cada canto
                if (resizeDir === 'se') {
                    newWidth = startWidth + dx;
                } else if (resizeDir === 'sw') {
                    newWidth = startWidth - dx;
                    newLeft = startLeft + dx;
                } else if (resizeDir === 'ne') {
                    newWidth = startWidth + dx;
                    // Ajustar Top baseado na mudança de altura (mantendo aspect ratio)
                    const newHeight = newWidth / aspectRatio;
                    newTop = startTop - (newHeight - startHeight);
                } else if (resizeDir === 'nw') {
                    newWidth = startWidth - dx;
                    newLeft = startLeft + dx;
                    const newHeight = newWidth / aspectRatio;
                    newTop = startTop - (newHeight - startHeight);
                }

                // Limites
                newWidth = Math.max(30, Math.min(300, newWidth));
                
                logoWrapper.style.width = `${newWidth}px`;
                logoWrapper.style.height = 'auto';
                logoContainer.style.left = `${newLeft}px`;
                logoContainer.style.top = `${newTop}px`;

                // Sync mirrors
                const sidebarMirrorsWrapper = document.querySelectorAll(`.queue-item-wrapper[data-id="${employee.id}"] .logo-resizable-wrapper`);
                sidebarMirrorsWrapper.forEach(mirrorWrapper => {
                    mirrorWrapper.style.width = `${newWidth}px`;
                    mirrorWrapper.style.height = 'auto';
                });
                
                const sidebarMirrorsContainer = document.querySelectorAll(`.queue-item-wrapper[data-id="${employee.id}"] .logo-container-absolute`);
                sidebarMirrorsContainer.forEach(mirror => {
                    mirror.style.left = `${newLeft}px`;
                    mirror.style.top = `${newTop}px`;
                });
            }
          };

          const onMouseUp = () => {
            if (isDragging || isResizing) {
                isDragging = false;
                isResizing = false;
                logoContainer.style.cursor = 'move';
                document.body.style.cursor = ''; // Reseta cursor global
                
                // Save position
                app.saveLogoSettings(employee.id, {
                  top: logoContainer.style.top,
                  left: logoContainer.style.left,
                  width: logoWrapper.style.width,
                  height: logoWrapper.style.height
                });
            }
          };

          logoContainer.addEventListener('mousedown', onMouseDown);
          window.addEventListener('mousemove', onMouseMove);
          window.addEventListener('mouseup', onMouseUp);
        }

        // Aplicar o zoom inicial (0.65) imediatamente ao renderizar
        updateTransform();
      },

      getLotoCardHtml(employee, isBackSide = false) {
        const defaultName = 'NOME DO FUNCIONÁRIO';
        const defaultRole = 'FUNÇÃO';
        const defaultSector = 'DEPARTAMENTO';
        const photoPlaceholderText = 'FOTO DO<br/>COLABORADOR';

        const name = employee?.name.toUpperCase() || defaultName;
        const role = employee?.role.toUpperCase() || defaultRole;
        const sector = employee?.sector.toUpperCase() || defaultSector;
        const photoSrc = employee?.photo;

        // Logic for Logo (LDC or Third Party)
        let logoHtml = LDC_LOGO_HTML;
        let logoContainerStyle = 'position: absolute; bottom: 4px; right: 4px; opacity: 0.9;';
        let logoWrapperStyle = 'width: 85px; height: 50px; display: flex; align-items: flex-end; justify-content: flex-end;';

        if (employee?.isThirdParty && employee?.companyLogo) {
          if (employee.logoSettings) {
            logoContainerStyle = `position: absolute; top: ${employee.logoSettings.top}; left: ${employee.logoSettings.left}; opacity: 0.9;`;
            logoWrapperStyle = `width: ${employee.logoSettings.width}; height: ${employee.logoSettings.height}; display: flex; align-items: flex-end; justify-content: flex-end;`;
          }
          logoHtml = `<div class="logo-resizable-wrapper" style="${logoWrapperStyle}"><img src="${employee.companyLogo}" alt="Logo Terceiro" style="max-width: 100%; max-height: 100%; object-fit: contain; pointer-events: none;" /></div>`;
        }

        let contentHtml = '';
        if (isBackSide) {
          contentHtml = `
            <div class="bg-white flex-grow border-2 border-black p-4 flex flex-col gap-6 text-sm font-bold uppercase leading-snug">
              <p>1. NÃO OPERE ESTE EQUIPAMENTO ATÉ QUE A PESSOA AUTORIZADA INDICADA NO VERSO REMOVA ESTA ETIQUETA.</p>
              <p>2. ESTA ETIQUETA E CADEADO SÓ PODEM SER REMOVIDOS PELA PESSOA INDICADA NO VERSO.</p>
            </div>
          `;
        } else {
          contentHtml = `
            <div class="bg-white p-2 text-center border-2 border-black"><h2 class="text-2xl font-bold uppercase leading-none">NÃO LIGUE</h2></div>
            <div class="flex flex-row gap-2 h-32">
              <div class="bg-white p-2 w-1/2 flex items-center justify-center border-2 border-black">
                <p class="font-bold text-sm uppercase leading-tight text-left">ESTOU<br/>TRABALHANDO<br/>NESTE<br/>EQUIPAMENTO</p>
              </div>
              <div class="bg-white w-1/2 border-2 border-black overflow-hidden relative flex items-center justify-center bg-gray-100">
                ${photoSrc ? `<img src="${photoSrc}" alt="Employee" class="w-full h-full object-cover" />` : `<div class="text-gray-400 text-xs text-center p-1 font-semibold" dangerouslySetInnerHTML={{ __html: photoPlaceholderText }}>${photoPlaceholderText}</div>`}
              </div>
            </div>
            <div class="bg-white flex-grow border-2 border-black p-2 flex flex-col justify-start gap-5 items-center text-center relative">
              <div class="flex flex-col gap-1 w-full pt-2"><span class="font-bold uppercase text-sm block truncate">${name}</span></div>
              <div class="flex flex-col gap-1 w-full"><span class="font-bold uppercase text-sm block truncate">${sector}</span></div>
              <div class="flex flex-col gap-1 w-full"><span class="font-bold uppercase text-sm block truncate">${role}</span></div>
              ${employee?.isThirdParty && employee?.companyLogo ? `<div class="logo-container-absolute" style="${logoContainerStyle}" data-employee-id="${employee.id}">${logoHtml}</div>` : `<div class="absolute bottom-1 right-1 opacity-90">${logoHtml}</div>`}
            </div>
          `;
        }

        return `
          <div class="flex flex-col items-center gap-4 group">
            <div class="loto-card relative flex flex-col items-center p-3 select-none">
              <div class="absolute top-4 w-4 h-4 bg-gray-800 rounded-full border-2 border-gray-600 opacity-80 z-20"></div>
              <div class="h-10 w-full"></div>
              <div class="w-full bg-loto-black p-2 mb-2">
                <div class="loto-header-border border-2 border-white rounded-full bg-loto-red py-1 px-4 overflow-hidden">
                  <div class="text-center"><h1 class="text-white font-black text-3xl uppercase tracking-wider leading-tight py-1">PERIGO</h1></div>
                </div>
              </div>
              <div class="flex flex-col w-full h-full gap-2">
                ${contentHtml}
                <div class="h-4"></div>
              </div>
            </div>
          </div>
        `;
      },

      getEmployeeCardHtml(employee) {
        const isInQueue = this.appState.queue.includes(employee.id);
        const imgContent = employee.photo ? `<img src="${employee.photo}" alt="${employee.name}" class="w-12 h-12 rounded-full object-cover border-2 border-white shadow-sm" />` : `<div class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center text-[10px] font-bold text-slate-400 border-2 border-white shadow-sm">IMG</div>`;
        const checkIcon = `
          <div class="check-icon absolute -top-1 -right-1 bg-loto-red text-white rounded-full p-1 shadow-md transition-all duration-300 ${isInQueue ? 'opacity-100 scale-100' : 'opacity-0 scale-50'}">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4"><polyline points="20 6 9 17 4 12"/></svg>
          </div>
        `;
        const editButton = `
          <button class="p-1.5 text-slate-300 hover:text-blue-500 hover:bg-blue-50 rounded-lg transition-colors edit-button opacity-0 group-hover:opacity-100 mr-1" title="Editar Colaborador" data-id="${employee.id}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
          </button>
        `;
        const deleteButton = `
          <button class="p-1.5 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors delete-button opacity-0 group-hover:opacity-100" title="Excluir Colaborador" data-id="${employee.id}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        `;

        return `
          <div class="shelf-card rounded-2xl p-4 cursor-pointer flex items-center gap-4 group overflow-visible ${isInQueue ? 'selected' : ''}" data-id="${employee.id}">
            <!-- <div class="shine-effect"></div> Removed shine for cleaner look -->
            <div class="relative">
              ${imgContent}
              ${checkIcon}
            </div>
            <div class="flex-1 min-w-0">
              <p class="text-xs font-bold text-slate-700 truncate">${employee.name}</p>
              <p class="text-[10px] text-slate-500 font-medium truncate">${employee.role}</p>
            </div>
            <div class="flex items-center">
                ${editButton}
                ${deleteButton}
            </div>
          </div>
        `;
      },

      getGalleryCardHtml(employee) {
        const isInQueue = this.appState.queue.includes(employee.id);
        const isSelectedForBulk = this.appState.selectedBulkIds.has(employee.id);

        const cardClasses = `
          gallery-card relative bg-white rounded-3xl shadow-sm border-0 overflow-hidden cursor-pointer group
          ${this.appState.isBulkMode ? 'bulk-mode' : ''}
          ${this.appState.isBulkMode && isSelectedForBulk ? 'border-4 border-slate-400' : ''}
          ${!this.appState.isBulkMode && isInQueue ? 'selected border-loto-red' : (!this.appState.isBulkMode ? 'hover:border-slate-300' : '')}
        `;

        const imgContent = employee.photo ? (
          `<img src="${employee.photo}" alt="${employee.name}" class="w-full h-full object-cover" />`
        ) : (
          `<div class="w-full h-full bg-slate-100 flex items-center justify-center text-slate-300">
            <svg width="24" height="24" stroke="currentColor" fill="none" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
          </div>`
        );

        const checkboxOverlay = this.appState.isBulkMode ? `
          <div class="absolute inset-0 bg-black/10 z-10 p-2 flex justify-end items-start pointer-events-none">
            <input type="checkbox" class="custom-checkbox" ${isSelectedForBulk ? 'checked' : ''} readOnly />
          </div>
        ` : '';

        const actionsOverlay = !this.appState.isBulkMode ? `
          <div class="absolute top-2 right-2 flex gap-2 z-20 opacity-0 group-hover:opacity-100 transition-opacity">
            <button class="bg-white/90 p-1.5 rounded-full text-slate-400 hover:text-red-600 shadow-sm transition-colors delete-button" title="Excluir" data-id="${employee.id}">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            </button>
            <button class="bg-white/90 p-1.5 rounded-full text-slate-400 hover:text-indigo-600 shadow-sm transition-colors edit-button" title="Editar" data-id="${employee.id}">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
            </button>
          </div>
        ` : '';

        const queueCheckmark = (!this.appState.isBulkMode && isInQueue) ? `
          <div class="absolute top-2 left-2 z-10 bg-loto-red text-white rounded-full p-1 shadow-md">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4"><polyline points="20 6 9 17 4 12"/></svg>
          </div>
        ` : '';

        return `
          <div class="${cardClasses} shadow-card hover:shadow-card-hover" data-id="${employee.id}">
            <div class="shine-effect"></div>
            ${imgContent}
            ${checkboxOverlay}
            ${actionsOverlay}
            ${queueCheckmark}
            <div class="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/80 to-transparent p-3 pt-6 text-white pointer-events-none">
              <p class="text-[10px] font-bold truncate">${employee.name}</p>
            </div>
          </div>
        `;
      },

      getQueueItemHtml(employee, index) {
        const isExpanded = this.appState.expandedQueue.has(employee.id);
        const lotoCardPreview = isExpanded ? `
          <div class="bg-slate-50 border-t border-slate-100 flex justify-center py-6 animate-slide-up h-[350px]">
            <div class="transform scale-[0.5] origin-top">
              ${this.getLotoCardHtml(employee, false)}
            </div>
          </div>
        ` : '';
        
        return `
          <div class="group bg-white rounded-2xl border ${isExpanded ? 'border-loto-red border-2 shadow-lg' : 'border-transparent shadow-card hover:shadow-md'} overflow-hidden cursor-pointer transition-all queue-item-wrapper" data-id="${employee.id}">
            <div class="flex items-center justify-between p-3 bg-slate-50">
              <div class="flex items-center gap-3">
                <div class="w-6 h-6 rounded-full bg-loto-red text-white text-[10px] font-bold flex items-center justify-center shadow-sm">${index}</div>
                <div class="flex flex-col">
                  <span class="text-xs font-bold text-slate-800">${employee.name}</span>
                  <span class="text-[10px] text-slate-500">${employee.role}</span>
                </div>
              </div>
              <div class="flex items-center gap-1">
                <button
                  class="p-1.5 text-slate-400 hover:text-indigo-600 transition-colors rounded-lg hover:bg-slate-200 expand-button"
                  title="Expandir/Recolher" data-id="${employee.id}"
                >
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="transform transition-transform ${isExpanded ? 'rotate-180' : ''}"><path d="m6 9 6 6 6-6"/></svg>
                </button>
                <button
                  class="p-1.5 text-slate-400 hover:text-red-500 transition-colors rounded-lg hover:bg-red-50 remove-button"
                  title="Remover da Fila" data-id="${employee.id}"
                >
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
              </div>
            </div>
            ${lotoCardPreview}
          </div>
        `;
      },

      // --- Core Logic Functions ---
      showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        if (!container) return;

        const toast = document.createElement('div');
        toast.className = `pointer-events-auto flex items-center gap-3 px-5 py-3 rounded-full shadow-[0_8px_30px_rgb(0,0,0,0.12)] border animate-toast transition-all transform hover:scale-105 cursor-pointer backdrop-blur-md ${
            type === 'success' ? 'bg-slate-900/95 text-white border-slate-800' : 
            type === 'error' ? 'bg-red-50/95 text-red-600 border-red-100' : 
            'bg-white/95 text-slate-700 border-slate-200'
        }`;
        
        let icon = '';
        if (type === 'success') icon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="text-emerald-400"><polyline points="20 6 9 17 4 12"/></svg>';
        else if (type === 'error') icon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
        else icon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-loto-red"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>';

        toast.innerHTML = `${icon}<span class="text-xs font-bold tracking-wide">${message}</span>`;

        container.appendChild(toast);
        this.playSystemSound(type === 'error' ? 'error' : (type === 'success' ? 'success' : 'pop'));

        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateY(-20px) scale(0.9)';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
        
        toast.addEventListener('click', () => toast.remove());
      },

      playSystemSound(type) {
        try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            const ctx = new AudioContext();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            const now = ctx.currentTime;
            
            if (type === 'success') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(587.33, now); osc.frequency.exponentialRampToValueAtTime(1174.66, now + 0.1);
                gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.4);
                osc.start(now); osc.stop(now + 0.4);
            } else if (type === 'pop') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(400, now);
                gain.gain.setValueAtTime(0.03, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'error') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(100, now + 0.2);
                gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0.001, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            }
        } catch (e) { console.error('Audio error', e); }
      },

      switchView(view) {
        this._updateState({ currentView: view });
      },

      showAlert(title, message) {
        this._updateState({
          isAlertModalOpen: true,
          alertModalContent: { title, message }
        });
      },

      closeAlertModal() {
        this._updateState({ isAlertModalOpen: false });
      },

      syncAlertModal() {
        const modal = document.getElementById('alert-modal');
        if (!modal) return;
        if (this.appState.isAlertModalOpen) {
          modal.classList.remove('hidden');
          document.getElementById('alert-modal-title').textContent = this.appState.alertModalContent.title;
          document.getElementById('alert-modal-message').textContent = this.appState.alertModalContent.message;
        } else {
          modal.classList.add('hidden');
        }
      },

      confirmAction(title, message, onConfirm) {
        this._updateState({
          isConfirmationModalOpen: true,
          confirmationModalContent: { title, message, onConfirm }
        });
      },

      closeConfirmationModal() {
        this._updateState({ isConfirmationModalOpen: false });
      },

      syncConfirmationModal() {
        const modal = document.getElementById('confirmation-modal');
        if (!modal) return;
        if (this.appState.isConfirmationModalOpen) {
          modal.classList.remove('hidden');
          document.getElementById('confirmation-modal-title').textContent = this.appState.confirmationModalContent.title;
          document.getElementById('confirmation-modal-message').textContent = this.appState.confirmationModalContent.message;
          
          const confirmButton = document.getElementById('confirmation-modal-confirm-button');
          if (confirmButton) {
            // Remove old listener to prevent multiple calls
            const oldConfirmHandler = confirmButton._eventHandler; // Store reference if needed for removal
            if (oldConfirmHandler) confirmButton.removeEventListener('click', oldConfirmHandler);

            const newConfirmHandler = () => {
              this.appState.confirmationModalContent.onConfirm();
              this.closeConfirmationModal();
            };
            confirmButton.addEventListener('click', newConfirmHandler);
            confirmButton._eventHandler = newConfirmHandler; // Store for future removal
          }

        } else {
          modal.classList.add('hidden');
        }
      },

      toggleThirdParty(isChecked) {
        this._updateState({ isThirdParty: isChecked });
        const logoSection = document.getElementById('company-logo-section');
        if (logoSection) {
          if (isChecked) logoSection.classList.remove('hidden');
          else logoSection.classList.add('hidden');
        }
      },

      setupDraggableToggle() {
        const label = document.getElementById('third-party-toggle-label');
        const input = document.getElementById('modal-input-is-third-party');
        if (!label || !input) return;

        let startX = 0;
        let isDragAction = false;

        const onPointerDown = (clientX) => {
            startX = clientX;
            isDragAction = false;
        };

        const onPointerMove = (clientX) => {
            const delta = clientX - startX;
            if (Math.abs(delta) > 5) {
                isDragAction = true;
                if (delta > 10 && !input.checked) {
                    input.checked = true;
                    this.toggleThirdParty(true);
                } else if (delta < -10 && input.checked) {
                    input.checked = false;
                    this.toggleThirdParty(false);
                }
            }
        };

        const addListeners = (startEvent, moveEvent, endEvent, getX) => {
            label.addEventListener(startEvent, (e) => {
                onPointerDown(getX(e));
                const onMove = (ev) => onPointerMove(getX(ev));
                const onEnd = () => {
                    window.removeEventListener(moveEvent, onMove);
                    window.removeEventListener(endEvent, onEnd);
                    setTimeout(() => { isDragAction = false; }, 50);
                };
                window.addEventListener(moveEvent, onMove);
                window.addEventListener(endEvent, onEnd);
            }, startEvent === 'touchstart' ? { passive: true } : undefined);
        };

        addListeners('mousedown', 'mousemove', 'mouseup', e => e.clientX);
        addListeners('touchstart', 'touchmove', 'touchend', e => e.touches[0].clientX);

        label.addEventListener('click', (e) => {
            if (isDragAction) {
                e.preventDefault();
                e.stopPropagation();
            }
        });
      },

      handleCompanyLogoUpload(file) {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          this._removeWhiteBackground(e.target?.result, (processedDataUrl) => {
            this._updateState({ tempCompanyLogo: processedDataUrl });
            this.updateCompanyLogoPreview();
          });
        };
        reader.readAsDataURL(file);
      },

      _removeWhiteBackground(imageSrc, callback) {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
          
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const data = imageData.data;
          const threshold = 240; // Considera branco acima de 240 (0-255)

          for (let i = 0; i < data.length; i += 4) {
            const r = data[i];
            const g = data[i + 1];
            const b = data[i + 2];
            
            // Se o pixel for quase branco, torna transparente
            if (r > threshold && g > threshold && b > threshold) {
              data[i + 3] = 0;
            }
          }
          
          ctx.putImageData(imageData, 0, 0);
          callback(canvas.toDataURL('image/png'));
        };
        img.src = imageSrc;
      },

      openNewEmployeeModal(id = null) {
        const employee = id ? this.appState.employees.find(e => e.id === id) : null;
        this._updateState({
          isNewEmployeeModalOpen: true,
          editingEmployeeId: id,
          tempPhoto: employee?.photo || null
        });
        
        // Initialize Third Party State
        this.appState.isThirdParty = employee?.isThirdParty || false;
        this.appState.tempCompanyLogo = employee?.companyLogo || null;

        // Sync initial form values
        const modalTitle = document.getElementById('new-employee-modal-title');
        const nameInput = document.getElementById('modal-input-name');
        const roleSelect = document.getElementById('modal-input-role');
        const isThirdPartyInput = document.getElementById('modal-input-is-third-party');
        const fileInputPhoto = document.getElementById('file-input-temp-photo');
        const fileInputLogo = document.getElementById('file-input-company-logo');

        if (modalTitle) modalTitle.textContent = id ? 'Editar Colaborador' : 'Adicionar à Equipe';
        if (nameInput) nameInput.value = employee ? employee.name : '';
        
        if (roleSelect) {
          roleSelect.innerHTML = ROLES.map(r => `<option value="${r}" ${employee?.role === r ? 'selected' : ''}>${r}</option>`).join('');
          roleSelect.value = employee ? employee.role : 'MECÂNICA';
        }
        
        // Sync Third Party UI
        if (isThirdPartyInput) {
          isThirdPartyInput.checked = this.appState.isThirdParty;
          this.toggleThirdParty(this.appState.isThirdParty);
        }

        this.updatePhotoPreview();
        this.updateCompanyLogoPreview();

        // Reset file input value when opening modal
        if (fileInputPhoto) fileInputPhoto.value = '';
        if (fileInputLogo) fileInputLogo.value = '';

        // Add paste listener
        document.addEventListener('paste', this._handlePaste.bind(this));
      },

      closeNewEmployeeModal() {
        this._updateState({ isNewEmployeeModalOpen: false, editingEmployeeId: null, tempPhoto: null, tempCompanyLogo: null, isThirdParty: false });
        document.removeEventListener('paste', this._handlePaste.bind(this)); // Remove paste listener
      },

      syncNewEmployeeModal() {
        const modal = document.getElementById('new-employee-modal');
        if (!modal) return;

        if (this.appState.isNewEmployeeModalOpen) {
          modal.classList.remove('hidden');
          this.updatePhotoPreview();
          this.updateCompanyLogoPreview();
        } else {
          modal.classList.add('hidden');
        }
      },

      updatePhotoPreview() {
        const tempPhotoPreview = document.getElementById('temp-photo-preview');
        const tempPhotoPlaceholder = document.getElementById('temp-photo-placeholder');
        const cropPhotoButton = document.getElementById('crop-photo-button');
        const deletePhotoButton = document.getElementById('delete-photo-button');

        if (this.appState.tempPhoto && tempPhotoPreview && tempPhotoPlaceholder && cropPhotoButton) {
          tempPhotoPreview.src = this.appState.tempPhoto;
          tempPhotoPreview.classList.remove('hidden');
          tempPhotoPlaceholder.classList.add('hidden');
          cropPhotoButton.classList.remove('hidden');
          if (deletePhotoButton) deletePhotoButton.classList.remove('hidden');
        } else if (tempPhotoPreview && tempPhotoPlaceholder && cropPhotoButton) {
          tempPhotoPreview.classList.add('hidden');
          tempPhotoPlaceholder.classList.remove('hidden');
          cropPhotoButton.classList.add('hidden');
          if (deletePhotoButton) deletePhotoButton.classList.add('hidden');
        }
      },

      updateCompanyLogoPreview() {
        const preview = document.getElementById('company-logo-preview');
        const placeholder = document.getElementById('company-logo-placeholder');
        const deleteButton = document.getElementById('delete-company-logo-button');
        
        if (this.appState.tempCompanyLogo && preview && placeholder) {
          preview.src = this.appState.tempCompanyLogo;
          preview.classList.remove('hidden');
          placeholder.classList.add('hidden');
          if (deleteButton) deleteButton.classList.remove('hidden');
        } else if (preview && placeholder) {
          preview.classList.add('hidden');
          placeholder.classList.remove('hidden');
          if (deleteButton) deleteButton.classList.add('hidden');
        }
      },

      _handlePaste(e) {
        const item = Array.from(e.clipboardData?.items || []).find(i => i.type.indexOf('image') !== -1);
        if (item) {
          const blob = item.getAsFile();
          if (blob) {
            // Check if hovering over company logo section
            const logoSection = document.getElementById('company-logo-section');
            const isHoveringLogo = logoSection && !logoSection.classList.contains('hidden') && logoSection.matches(':hover');
            if (isHoveringLogo) {
              this.handleCompanyLogoUpload(blob);
            } else {
              this.handleImageUpload(blob);
            }
          }
        }
      },

      handleImageUpload(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          this._updateState({ tempPhoto: e.target?.result });
        };
        reader.readAsDataURL(file);
      },

      removeTempPhoto() {
        this._updateState({ tempPhoto: null });
        this.updatePhotoPreview();
        const fileInput = document.getElementById('file-input-temp-photo');
        if (fileInput) fileInput.value = '';
      },

      removeCompanyLogo() {
        this._updateState({ tempCompanyLogo: null });
        this.updateCompanyLogoPreview();
        const fileInput = document.getElementById('file-input-company-logo');
        if (fileInput) fileInput.value = '';
      },

      async pasteCompanyLogo() {
        try {
          const items = await navigator.clipboard.read();
          for (const item of items) {
            if (item.types.some(type => type.startsWith('image/'))) {
              const blob = await item.getType(item.types.find(type => type.startsWith('image/')));
              this.handleCompanyLogoUpload(blob);
              return;
            }
          }
          this.showAlert('Atenção', 'Nenhuma imagem encontrada na área de transferência.');
        } catch (err) {
          console.error(err);
          this.showAlert('Erro', 'Não foi possível acessar a área de transferência. Tente usar Ctrl+V sobre a área do logo.');
        }
      },

      _addToRecents(id) {
        let newRecents = [id, ...this.appState.recents.filter(rId => rId !== id)];
        if (newRecents.length > 15) newRecents = newRecents.slice(0, 15); // Keep last 15
        this._updateState({ recents: newRecents }, false);
      },

      async _uploadBase64(base64, bucket, path) {
        try {
            const response = await fetch(base64);
            const blob = await response.blob();
            
            let { data, error } = await supabaseClient.storage
              .from(bucket)
              .upload(path, blob, {
                contentType: blob.type,
                upsert: true,
              });

            // Tratamento automático: Se o bucket não existir, tenta criar
            if (error && (error.message.includes('Bucket not found') || error.statusCode === '404')) {
                console.warn(`Bucket '${bucket}' não encontrado. Tentando criar automaticamente...`);
                const { error: createError } = await supabaseClient.storage.createBucket(bucket, {
                    public: true,
                    fileSizeLimit: 10485760, // 10MB
                    allowedMimeTypes: ['image/png', 'image/jpeg', 'image/gif', 'image/webp']
                });

                if (createError) {
                    console.error('Falha ao criar bucket:', createError);
                    // Mensagem específica para erro de permissão (RLS)
                    if (createError.message && createError.message.includes('policy')) {
                        return { url: null, error: { message: `Permissão negada. Vá ao Supabase > Storage e crie o bucket '${bucket}' como 'Public'.` } };
                    }
                    return { url: null, error: { message: `Bucket '${bucket}' não encontrado. Crie-o manualmente no painel do Supabase.` } };
                }

                // Tenta o upload novamente
                const retry = await supabaseClient.storage.from(bucket).upload(path, blob, { contentType: blob.type, upsert: true });
                data = retry.data;
                error = retry.error;
            }

            if (error) {
                // Tratamento específico para erro de permissão (RLS)
                if (error.message && error.message.includes('row-level security policy')) {
                    return { url: null, error: { message: `Permissão negada: Habilite 'INSERT' nas Policies do bucket '${bucket}' no Supabase.` } };
                }
                throw error;
            }

            const { data: { publicUrl } } = supabaseClient.storage.from(bucket).getPublicUrl(path);
            return { url: publicUrl, error: null };
        } catch (error) {
            console.error(`Erro no upload de base64 para ${bucket}:`, error);
            return { url: null, error };
        }
      },

      async saveNewEmployee() {
        const nameInput = document.getElementById('modal-input-name');
        const roleSelect = document.getElementById('modal-input-role');
        const name = nameInput ? nameInput.value.trim().toUpperCase() : '';
        const role = roleSelect ? roleSelect.value : 'MECÂNICA';
        const isThirdParty = this.appState.isThirdParty;

        if (!name) {
          this.showAlert('Campo Obrigatório', 'Por favor, insira o nome do colaborador.');
          return;
        }

        this.showToast('Salvando...', 'pop');

        // 1. MODO SIMPLIFICADO: Salvar Base64 direto no Banco (Sem Storage/Bucket)
        // Isso elimina a necessidade de configurar Buckets e Policies no Supabase.
        // A imagem é salva como texto diretamente na coluna 'photo' e 'companyLogo'.
        const photoUrl = this.appState.tempPhoto;
        const logoUrl = this.appState.tempCompanyLogo;

        const employeeData = {
            name,
            role,
            sector: 'MANUTENÇÃO',
            photo: photoUrl,
            isThirdParty,
            companyLogo: logoUrl,
        };

        if (this.appState.editingEmployeeId) {
            employeeData.id = this.appState.editingEmployeeId;
            const existingEmployee = this.appState.employees.find(e => e.id === employeeData.id);
            // Preserve existing logo settings if they exist
            if (existingEmployee?.logoSettings) {
                employeeData.logoSettings = existingEmployee.logoSettings;
            }
        }

        // 3. Upsert employee data to Supabase
        const { data: savedEmployee, error } = await supabaseClient
            .from('employees')
            .upsert(employeeData)
            .select()
            .single();

        if (error) {
            console.error('Erro ao salvar colaborador:', error);
            this.showToast('Erro ao salvar no banco de dados.', 'error');
            return;
        }

        // 4. Update local state
        let newEmployees = [...this.appState.employees];
        const existingIndex = newEmployees.findIndex(e => e.id === savedEmployee.id);
        if (existingIndex > -1) newEmployees[existingIndex] = savedEmployee;
        else newEmployees.unshift(savedEmployee);
        
        this._updateState({ employees: newEmployees });
        this.closeNewEmployeeModal();
        this.showToast(this.appState.editingEmployeeId ? 'Colaborador atualizado!' : 'Colaborador adicionado!', 'success');
      },

      deleteEmployee(id) {
        this.confirmAction('Remover Colaborador?', 'Esta ação é permanente e não poderá ser desfeita.', async () => {
          const employeeToDelete = this.appState.employees.find(e => e.id === id);
          if (!employeeToDelete) return;

          // Delete from Supabase DB
          const { error } = await supabaseClient.from('employees').delete().eq('id', id);
          if (error) {
            console.error('Erro ao excluir colaborador:', error);
            this.showToast('Erro ao excluir do banco de dados.', 'error');
            return;
          }

          // Delete images from Supabase Storage
          const filesToDelete = [];
          if (employeeToDelete.photo) {
            const photoPath = employeeToDelete.photo.split('/avatars/')[1];
            if (photoPath) filesToDelete.push(photoPath);
          }
          if (employeeToDelete.companyLogo) {
            const logoPath = employeeToDelete.companyLogo.split('/avatars/')[1];
            if (logoPath) filesToDelete.push(logoPath);
          }
          if (filesToDelete.length > 0) await supabaseClient.storage.from('avatars').remove(filesToDelete);

          // Update local state
          const updatedQueue = this.appState.queue.filter(qid => qid !== id);
          const updatedRecents = this.appState.recents.filter(rid => rid !== id);
          let newPreviewId = this.appState.currentPreviewId;

          if (newPreviewId === id) {
            if (updatedQueue.length > 0) {
              newPreviewId = updatedQueue[updatedQueue.length - 1];
            } else {
              newPreviewId = null;
            }
          }
          this._updateState({
            employees: this.appState.employees.filter(e => e.id !== id),
            queue: updatedQueue,
            recents: updatedRecents,
            currentPreviewId: newPreviewId
          });
          this.showToast('Colaborador removido.', 'pop');
          this._saveRecents();
        });
      },

      deleteAllEmployees() {
        this.confirmAction('Excluir Todos?', 'Tem certeza que deseja remover todos os colaboradores? Esta ação não pode ser desfeita.', async () => {
          // Delete all rows from the table
          const { error } = await supabaseClient.from('employees').delete().neq('id', -1); // Deletes all rows
          if (error) {
            this.showToast('Erro ao excluir todos os colaboradores.', 'error');
            console.error(error);
            return;
          }
          // Note: This does not delete files from storage. That would require listing all files and deleting them.

          this._updateState({
            employees: [],
            queue: [],
            recents: [],
            currentPreviewId: null,
            expandedQueue: new Set(),
            selectedBulkIds: new Set(),
          });
          this.showToast('Todos os colaboradores foram removidos.', 'pop');
        });
      },

      startCropping(src) {
        this._updateState({ imageToCropSrc: src, isCropModalOpen: true });
      },

      closeCropModal() {
        if (this.appState.cropperInstance) {
          this.appState.cropperInstance.destroy();
          this._updateState({ cropperInstance: null });
        }
        this._updateState({ isCropModalOpen: false });
      },

      syncCropModal() {
        const modal = document.getElementById('crop-modal');
        if (!modal) return;

        if (this.appState.isCropModalOpen) {
          modal.classList.remove('hidden');
          const imageToCrop = document.getElementById('image-to-crop');
          if (imageToCrop) {
            imageToCrop.src = this.appState.imageToCropSrc;
            // Ensure image is loaded before initializing Cropper
            imageToCrop.onload = () => {
              if (this.appState.cropperInstance) {
                this.appState.cropperInstance.destroy();
              }
              const newCropper = new Cropper(imageToCrop, {
                aspectRatio: 1,
                viewMode: 1,
                autoCropArea: 0.9,
                dragMode: 'move',
                background: false,
                zoomable: true,
                movable: true,
                cropBoxResizable: false,
                cropBoxMovable: false,
                toggleDragModeOnDblclick: false,
                ready() {
                    const viewBox = this.cropper.cropper.querySelector('.cropper-view-box');
                    const face = this.cropper.cropper.querySelector('.cropper-face');
                    if (viewBox) viewBox.style.borderRadius = '50%';
                    if (face) face.style.borderRadius = '50%';
                }
              });
              this._updateState({ cropperInstance: newCropper }); // Update state after instance is ready
            };
          }
        } else {
          modal.classList.add('hidden');
          // No need to destroy here, cleanup is handled in closeCropModal or useEffect like logic
        }
      },

      performCrop() {
        if (this.appState.cropperInstance) {
          const canvas = this.appState.cropperInstance.getCroppedCanvas({
            width: 300,
            height: 300,
          });
          const croppedDataUrl = canvas.toDataURL('image/jpeg', 0.9);
          this._updateState({ tempPhoto: croppedDataUrl });
          this.updatePhotoPreview(); // Ensure UI updates immediately
          this.closeCropModal();
        }
      },

      toggleQueue(id) {
        let newQueue;
        if (this.appState.queue.includes(id)) {
          newQueue = this.appState.queue.filter(q => q !== id);
        } else {
          newQueue = [...this.appState.queue, id];
        }

        let newPreviewId = this.appState.currentPreviewId;
        if (!this.appState.queue.includes(id)) { // If adding to queue
          newPreviewId = id;
        } else if (newPreviewId === id) { // If removing the current previewed item
          if (newQueue.length > 0) {
            newPreviewId = newQueue[newQueue.length - 1];
          } else {
            newPreviewId = null;
          }
        }
        this._updateState({ queue: newQueue, currentPreviewId: newPreviewId });
        
        if (this.appState.queue.includes(id)) {
            this.showToast('Adicionado à fila de impressão', 'pop');
        } else {
            this.showToast('Removido da fila', 'pop');
        }
      },

      removeFromQueue(id) {
        const newQueue = this.appState.queue.filter(q => q !== id);
        let newPreviewId = this.appState.currentPreviewId;

        if (newPreviewId === id) {
          if (newQueue.length > 0) {
            newPreviewId = newQueue[newQueue.length - 1];
          } else {
            newPreviewId = null;
          }
        }
        this._updateState({ queue: newQueue, currentPreviewId: newPreviewId });
        this.showToast('Removido da fila', 'pop');
      },

      clearQueue() {
        this.confirmAction('Limpar Fila?', 'Deseja remover todos os colaboradores da fila de impressão?', () => {
          this._updateState({ queue: [], currentPreviewId: null, expandedQueue: new Set() });
          this.showToast('Fila limpa com sucesso.', 'pop');
        });
      },

      clearRecents() {
        this.confirmAction('Limpar Histórico?', 'Isso removerá a lista de colaboradores recentes, mas não os excluirá da equipe.', async () => {
          this._updateState({ recents: [] });
          await this._saveRecents();
          this.showToast('Histórico limpo.', 'pop');
        });
      },

      toggleExpand(id) {
        const newExpanded = new Set(this.appState.expandedQueue);
        if (newExpanded.has(id)) {
          newExpanded.delete(id);
        } else {
          newExpanded.add(id);
        }
        this._updateState({ expandedQueue: newExpanded });
      },

      toggleBulkMode() {
        let newBulkMode = !this.appState.isBulkMode;
        let newSelectedBulkIds = new Set();
        if (this.appState.isBulkMode) { // If turning off bulk mode, clear selections
          newSelectedBulkIds = new Set();
        } else { // If turning on bulk mode, pre-select all if there's a specific use case, or none
          newSelectedBulkIds = new Set(); // Start with empty selection
        }
        this._updateState({ isBulkMode: newBulkMode, selectedBulkIds: newSelectedBulkIds });
      },

      toggleBulkSelection(id) {
        const newSelection = new Set(this.appState.selectedBulkIds);
        if (newSelection.has(id)) {
          newSelection.delete(id);
        } else {
          newSelection.add(id);
        }
        this._updateState({ selectedBulkIds: newSelection });
      },

      deleteBulk() {
        if (this.appState.selectedBulkIds.size === 0) return;
        const idsToDelete = Array.from(this.appState.selectedBulkIds);
        this.confirmAction('Excluir Itens?', `Deseja apagar ${idsToDelete.length} colaboradores selecionados?`, async () => {
          // 1. Find files to delete before deleting the database records
          const employeesToDelete = this.appState.employees.filter(e => idsToDelete.includes(e.id));
          const filesToDelete = [];
          employeesToDelete.forEach(employee => {
            if (employee.photo) {
              const photoPath = employee.photo.split('/avatars/')[1];
              if (photoPath) filesToDelete.push(photoPath);
            }
            if (employee.companyLogo) {
              const logoPath = employee.companyLogo.split('/avatars/')[1];
              if (logoPath) filesToDelete.push(logoPath);
            }
          });

          // 2. Delete from Supabase DB
          const { error } = await supabaseClient.from('employees').delete().in('id', idsToDelete);
          if (error) {
            this.showToast('Erro ao excluir itens.', 'error');
            console.error(error);
            return;
          }
          
          // 3. Delete files from Supabase Storage
          if (filesToDelete.length > 0) {
            await supabaseClient.storage.from('avatars').remove(filesToDelete);
          }

          // 4. Update local state
          const updatedEmployees = this.appState.employees.filter(e => !this.appState.selectedBulkIds.has(e.id));
          const updatedQueue = this.appState.queue.filter(qid => !this.appState.selectedBulkIds.has(qid));
          const updatedRecents = this.appState.recents.filter(rid => !this.appState.selectedBulkIds.has(rid));
          let newPreviewId = this.appState.currentPreviewId;

          if (newPreviewId && this.appState.selectedBulkIds.has(newPreviewId)) {
            if (updatedQueue.length > 0) {
              newPreviewId = updatedQueue[updatedQueue.length - 1];
            } else {
              newPreviewId = null;
            }
          }
          this._updateState({ employees: updatedEmployees, queue: updatedQueue, recents: updatedRecents, currentPreviewId: newPreviewId, selectedBulkIds: new Set() });
          this.toggleBulkMode(); // Exit bulk mode after deletion
          this.showToast(`${idsToDelete.length} itens excluídos.`, 'pop');
          this._saveRecents();
        });
      },

      setCurrentPreviewId(id) {
        this._updateState({ currentPreviewId: id });
      },
      
      async saveLogoSettings(id, settings) {
        // Atualiza estado local primeiro (UI otimista)
        const employees = this.appState.employees.map(e => 
          e.id === id ? { ...e, logoSettings: settings } : e
        );
        this._updateState({ employees }, false);

        // Save to Supabase in the background
        const { error } = await supabaseClient
          .from('employees')
          .update({ logoSettings: settings })
          .eq('id', id);

        if (error) this.showToast('Erro ao salvar posição do logo.', 'error');
      },

      // Função auxiliar para atualizar a barra de progresso
      async _simulatePrintProgress(start, end, duration, message) {
        const bar = document.getElementById('print-progress-bar');
        const percentText = document.getElementById('print-progress-percent');
        const statusText = document.getElementById('print-status-text');
        
        if (message) statusText.textContent = message;
        
        const stepTime = 20;
        const steps = duration / stepTime;
        const increment = (end - start) / steps;
        
        let current = start;
        
        return new Promise(resolve => {
            const timer = setInterval(() => {
                current += increment;
                if (current >= end) {
                    current = end;
                    clearInterval(timer);
                    resolve();
                }
                bar.style.width = `${current}%`;
                percentText.textContent = `${Math.round(current)}%`;
            }, stepTime);
        });
      },

      async printQueue() {
        if (this.appState.activeSaveCallback) {
            this.appState.activeSaveCallback();
        }
        if (this.appState.queue.length === 0) return;

        // Adicionar itens da fila aos recentes (Histórico de Impressão)
        this.appState.queue.forEach(id => {
            this._addToRecents(id);
        });
        this._saveRecents();

        // 1. Iniciar Interface de Progresso
        const overlay = document.getElementById('print-progress-overlay');
        overlay.classList.remove('hidden');
        
        // Simula etapa 1: Processando dados
        await this._simulatePrintProgress(0, 30, 600, "Processando dados dos colaboradores...");

        const area = document.getElementById('print-batch-area');
        if (!area) return;
        area.innerHTML = '';
        const selectedEmployees = this.appState.queue.map(id => this.appState.employees.find(e => e.id === id)).filter(e => e);
        const pairs = [];
        for (let i = 0; i < selectedEmployees.length; i += 2) pairs.push(selectedEmployees.slice(i, i + 2));

        let html = '';
        pairs.forEach(pair => {
          html += '<div class="print-page">';
          pair.forEach(d => {
            const img = d.photo ? `<img src="${d.photo}" class="w-full h-full object-cover">` : `<div class="text-gray-400 text-xs text-center font-semibold p-2">FOTO</div>`;
            
            let logoHtml = LDC_LOGO_HTML;
            if (d.isThirdParty && d.companyLogo) {
              let logoContainerStyle = 'position: absolute; bottom: 4px; right: 4px; opacity: 0.9;';
              let logoWrapperStyle = 'width: 85px; height: 50px; display: flex; align-items: flex-end; justify-content: flex-end;';
              
              if (d.logoSettings) {
                logoContainerStyle = `position: absolute; top: ${d.logoSettings.top}; left: ${d.logoSettings.left}; opacity: 0.9;`;
                logoWrapperStyle = `width: ${d.logoSettings.width}; height: ${d.logoSettings.height}; display: flex; align-items: flex-end; justify-content: flex-end;`;
              }
              
              logoHtml = `<div style="${logoContainerStyle}"><div style="${logoWrapperStyle}"><img src="${d.companyLogo}" style="max-width: 100%; max-height: 100%; object-fit: contain;" /></div></div>`;
            }

            html += `
              <div class="print-row">
                  <div class="loto-card relative flex flex-col items-center p-3">
                      <div class="h-10 w-full"></div><div class="w-full bg-loto-black p-2 mb-2"><div class="loto-header-border border-2 border-white rounded-full bg-loto-red py-1 px-4 overflow-hidden"><div class="text-center"><h1 class="text-white font-black text-3xl uppercase tracking-wider leading-tight py-1">PERIGO</h1></div></div></div>
                      <div class="flex flex-col w-full h-full gap-2">
                          <div class="bg-white p-2 text-center border-2 border-black"><h2 class="text-2xl font-bold uppercase leading-none">NÃO LIGUE</h2></div>
                          <div class="flex flex-row gap-2 h-32">
                              <div class="bg-white p-2 w-1/2 flex items-center justify-center border-2 border-black"><p class="font-bold text-sm uppercase leading-tight text-left">ESTOU<br/>TRABALHANDO<br/>NESTE<br/>EQUIPAMENTO</p></div>
                              <div class="bg-white w-1/2 border-2 border-black overflow-hidden relative flex items-center justify-center bg-gray-100">${img}</div>
                          </div>
                          <div class="bg-white flex-grow border-2 border-black p-2 flex flex-col justify-start gap-5 items-center text-center relative">
                              <div class="flex flex-col gap-1 w-full pt-2"><span class="font-bold uppercase text-sm block">${d.name}</span></div>
                              <div class="flex flex-col gap-1 w-full"><span class="font-bold uppercase text-sm block">${d.sector}</span></div>
                              <div class="flex flex-col gap-1 w-full"><span class="font-bold uppercase text-sm block">${d.role}</span></div>
                              ${d.isThirdParty && d.companyLogo ? logoHtml : `<div class="absolute bottom-1 right-1 opacity-90">${logoHtml}</div>`}
                          </div>
                      </div>
                  </div>
                  <div class="loto-card relative flex flex-col items-center p-3">
                      <div class="h-10 w-full"></div><div class="w-full bg-loto-black p-2 mb-2"><div class="loto-header-border border-2 border-white rounded-full bg-loto-red py-1 px-4 overflow-hidden"><div class="text-center"><h1 class="text-white font-black text-3xl uppercase tracking-wider leading-tight py-1">PERIGO</h1></div></div></div>
                      <div class="flex flex-col w-full h-full gap-2">
                          <div class="bg-white flex-grow border-2 border-black p-4 flex flex-col gap-6 text-sm font-bold uppercase leading-snug">
                              <p>1. NÃO OPERE ESTE EQUIPAMENTO ATÉ QUE A PESSOA AUTORIZADA INDICADA NO VERSO REMOVA ESTA ETIQUETA.</p>
                              <p>2. ESTA ETIQUETA E CADEADO SÓ PODEM SER REMOVIDOS PELA PESSOA INDICADA NO VERSO.</p>
                          </div>
                          <div class="h-4"></div>
                      </div>
                  </div>
              </div>`;
          });
          html += '</div>';
        });
        area.innerHTML = html;

        // Simula etapa 2: Gerando Layout
        await this._simulatePrintProgress(30, 60, 500, "Gerando layout de impressão...");

        // Wait for images to load before printing
        const imgs = [...area.querySelectorAll('img')];
        const imagePromises = imgs.map(img => {
          if (img.complete) return Promise.resolve();
          return new Promise(r => { img.onload = r; img.onerror = r; });
        });

        // Simula etapa 3: Carregando Imagens (enquanto espera de verdade)
        await Promise.all([
            Promise.all(imagePromises),
            this._simulatePrintProgress(60, 90, 800, "Otimizando imagens de alta resolução...")
        ]);

        // Finalização
        await this._simulatePrintProgress(90, 100, 300, "Enviando para a impressora...");

        // Pequeno delay para o usuário ver o 100%
        setTimeout(() => {
            overlay.classList.add('hidden');
            
            // Configura o evento para depois da impressão
            const afterPrintHandler = () => {
                // Remove o listener para não duplicar
                window.removeEventListener('afterprint', afterPrintHandler); // Standard
                
                // Pergunta se deu certo
                setTimeout(() => {
                    this.confirmAction('Impressão Concluída?', 'Os cartões foram impressos corretamente? Se sim, a fila será limpa.', () => {
                        this._updateState({ queue: [], currentPreviewId: null, expandedQueue: new Set() });
                        this.showToast('Fila de impressão finalizada.', 'success');
                    });
                }, 500);
            };

            // Tenta capturar o fechamento da janela de impressão
            window.addEventListener('afterprint', afterPrintHandler);
            
            // Abre a janela de impressão
            window.print();
            
            // Fallback para navegadores que não suportam afterprint perfeitamente (opcional, mas seguro)
            // Em alguns casos o script continua rodando imediatamente, então o modal apareceria "atrás" do dialog de print.
            // O afterprint é o método mais correto.
        }, 500);
      },

      listenForRealtimeChanges() {
        const channel = supabaseClient
          .channel('employees-db-changes')
          .on(
            'postgres_changes',
            { event: '*', schema: 'public', table: 'employees' },
            (payload) => {
              console.log('Realtime change received!', payload);
              const { eventType, new: newRecord, old: oldRecord } = payload;

              let currentEmployees = [...this.appState.employees];
              let changed = false;

              switch (eventType) {
                case 'INSERT':
                  // Evita adicionar duplicatas se o cliente que originou a ação já o adicionou de forma otimista.
                  if (!currentEmployees.some(e => e.id === newRecord.id)) {
                    currentEmployees.unshift(newRecord);
                    changed = true;
                    this.showToast(`Novo colaborador: ${newRecord.name}`, 'pop');
                  }
                  break;

                case 'UPDATE':
                  const indexToUpdate = currentEmployees.findIndex(e => e.id === newRecord.id);
                  if (indexToUpdate !== -1) {
                    // Apenas atualiza se os dados forem realmente diferentes para evitar re-renderizações desnecessárias.
                    if (JSON.stringify(currentEmployees[indexToUpdate]) !== JSON.stringify(newRecord)) {
                        currentEmployees[indexToUpdate] = newRecord;
                        changed = true;
                    }
                  }
                  break;

                case 'DELETE':
                  const idToDelete = oldRecord.id;
                  const initialLength = currentEmployees.length;
                  currentEmployees = currentEmployees.filter(e => e.id !== idToDelete);
                  if (currentEmployees.length < initialLength) {
                    changed = true;
                  }
                  break;
              }

              if (changed) {
                const updatedQueue = this.appState.queue.filter(id => currentEmployees.some(e => e.id === id));
                const updatedRecents = this.appState.recents.filter(id => currentEmployees.some(e => e.id === id));
                let updatedPreviewId = this.appState.currentPreviewId;

                if (eventType === 'DELETE' && this.appState.currentPreviewId === oldRecord.id) {
                  updatedPreviewId = updatedQueue.length > 0 ? updatedQueue[updatedQueue.length - 1] : (currentEmployees.length > 0 ? currentEmployees[0].id : null);
                } else if (updatedPreviewId && !currentEmployees.some(e => e.id === updatedPreviewId)) {
                  updatedPreviewId = null;
                }
                this._updateState({ employees: currentEmployees, queue: updatedQueue, recents: updatedRecents, currentPreviewId: updatedPreviewId });
              }
            }
          )
          .subscribe();
      },
      // --- Initialization ---
      async init() {
        if (SUPABASE_URL === 'SEU_SUPABASE_URL' || SUPABASE_ANON_KEY === 'SUA_SUPABASE_ANON_KEY') {
          this.showAlert('Configuração Incompleta', 'Por favor, adicione sua URL e Chave anônima do Supabase no código para começar.');
          this._updateState({ isLoading: false });
          return;
        }

        // Inicializa o cliente Supabase somente se as credenciais forem válidas
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Render the app immediately. Since isLoading is true by default, it will show the loader.
        this.renderApp();

        // Now, load the data in the background.
        await this._loadInitialData();
        
        // Data is loaded, update state to remove loader and show content.
        this._updateState({ isLoading: false });

        // Inicia a escuta por atualizações em tempo real
        this.listenForRealtimeChanges();

        this.setupDraggableToggle();

        // Attach event listeners for NewEmployeeModal form submission
        document.getElementById('modal-save-employee-button')?.addEventListener('click', () => this.saveNewEmployee());
        document.getElementById('file-input-temp-photo')?.addEventListener('change', (e) => {
          if (e.target.files && e.target.files[0]) {
            this.handleImageUpload(e.target.files[0]);
          }
        });

        // Set up initial state of currentPreviewId
        if (this.appState.queue.length > 0) {
          this._updateState({ currentPreviewId: this.appState.queue[this.appState.queue.length - 1] });
        } else if (this.appState.employees.length > 0) {
          // If no queue, maybe show the first employee as a default preview?
          // This behavior was implicitly handled in React. For vanilla, let's keep it null if queue is empty.
          this._updateState({ currentPreviewId: null }); 
        }

        // Periodically check and update currentPreviewId if queue or employees change
        // This simulates a useEffect for currentPreviewId cleanup, simplified for vanilla
        setInterval(() => {
          if (this.appState.currentPreviewId) {
            const isPreviewIdStillValid = this.appState.queue.includes(this.appState.currentPreviewId) ||
                                         this.appState.employees.some(e => e.id === this.appState.currentPreviewId);
            if (!isPreviewIdStillValid) {
              let newPreviewId = null;
              if (this.appState.queue.length > 0) {
                newPreviewId = this.appState.queue[this.appState.queue.length - 1];
              }
              this._updateState({ currentPreviewId: newPreviewId });
            }
          }
        }, 1000); // Check every second for simplicity
      }
    };

    // Initialize the app when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', () => {
      app.init();
    });
  </script>
</body>
</html>